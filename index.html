<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‹•ç‰©å¤§è³½è·‘</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f0f0f0; padding: 10px; margin: 0; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { margin: 10px 0; font-size: 24px; text-align: center; }
        h3 { margin: 10px 0; font-size: 18px; border-left: 4px solid #007bff; padding-left: 10px; }

        /* --- è³‡è¨Šé¢æ¿ --- */
        .info-panel { display: flex; flex-wrap: wrap; justify-content: space-between; margin-bottom: 15px; padding: 10px; background: #e0e7ff; border-radius: 8px; font-weight: bold; border: 2px solid #4f46e5; align-items: center; }
        .funds-group { display: flex; flex-direction: column; }
        .relief-info { color: #d97706; font-size: 12px; margin-top: 5px; }
        
        /* --- å ´åœ°é¸æ“‡ (RWD å„ªåŒ–) --- */
        .venue-selection { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px; 
            margin-bottom: 20px; 
        }
        .venue-card { background: #fff; border: 2px solid #ccc; padding: 8px; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; min-width: 0; }
        .venue-card:hover { transform: translateY(-3px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .venue-card.active { border-color: #f59e0b; background: #fffbeb; box-shadow: 0 0 0 2px #f59e0b; }
        .venue-card.locked { background: #e5e5e5; color: #888; cursor: not-allowed; border-color: #999; }
        .venue-name { font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .venue-fee { font-size: 11px; color: #666; margin-top: 2px; }
        .chaos-level { font-size: 10px; color: #dc3545; font-weight: bold; margin-top: 2px; }

        /* --- è³½é“ --- */
        .track-area { margin: 15px 0; border: 2px solid #333; padding: 5px; background: #555; border-radius: 5px; }
        .lane { margin-bottom: 8px; background: #333; padding: 2px; border-radius: 4px; position: relative; height: 36px; }
        .lane-name { color: white; position: absolute; left: 5px; top: 50%; transform: translateY(-50%); z-index: 2; font-size: 12px; text-shadow: 1px 1px 2px black; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); width: 0%; border-radius: 4px; transition: width 0.05s linear; position: relative; }
        .animal-icon { position: absolute; right: -12px; top: -6px; font-size: 22px; transition: right 0.05s linear; }
        .status-text { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); color: yellow; font-size: 10px; font-weight: bold; text-shadow: 1px 1px 2px black;}

        /* --- ä¸‹æ³¨å€ (RWD å„ªåŒ–) --- */
        .betting-area { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
        .bet-card { border: 1px solid #ccc; padding: 8px; border-radius: 5px; text-align: center; cursor: pointer; transition: 0.3s; position: relative; }
        .bet-card.selected { background: #d1fae5; border-color: #10b981; border-width: 2px; }
        .bet-card.disabled { opacity: 0.6; cursor: not-allowed; }
        .odds-text { color:red; font-weight:bold; font-size:16px; }
        .fav-weather { font-size: 11px; color: #555; margin-top: 2px; background: #eee; border-radius: 4px; padding: 2px;}

        /* --- æ§åˆ¶å€ --- */
        .controls { text-align: center; margin-top: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; }
        .bet-input-group { margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 4px; flex-wrap: wrap; }
        button { padding: 8px 12px; font-size: 14px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; touch-action: manipulation; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .quick-btn { background: #17a2b8; font-size: 12px; padding: 8px 10px; min-width: 50px; }
        .quick-btn.minus { background: #dc3545; }
        .reset-btn { background: #6c757d; }
        
        input[type="number"] { padding: 8px; font-size: 16px; width: 100px; text-align: center; border: 2px solid #ddd; border-radius: 4px; }
        .min-bet-hint { display: block; font-size: 12px; color: #666; margin-top: 5px; }

        .log-area { height: 120px; overflow-y: auto; background: #222; color: #0f0; padding: 8px; margin-top: 15px; font-family: monospace; border-radius: 5px; font-size: 11px; }

        /* --- é–‹ç™¼è€…æ¨¡å¼æ¨£å¼ --- */
        #dev-trigger-btn { margin-top: 20px; background: #333; color: #555; font-size: 10px; padding: 5px; border-radius: 3px; float: right; }
        #dev-panel { display: none; background: #2c3e50; color: white; padding: 15px; border-radius: 8px; margin-top: 20px; border: 2px solid #e74c3c; }
        #dev-panel h4 { margin-top: 0; color: #e74c3c; }
        .dev-controls { display: flex; gap: 5px; flex-wrap: wrap; }
        .dev-btn { background: #e67e22; font-size: 12px; }
        .dev-btn.danger { background: #c0392b; }
        .dev-active-border { border: 2px dashed #e74c3c !important; } /* ä¸‹æ³¨å¡åœ¨é–‹ç™¼è€…æ¨¡å¼ä¸‹çš„ç‰¹æ•ˆ */

        /* --- éŸ¿æ‡‰å¼è¨­è¨ˆ (Mobile) --- */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .venue-selection { 
                grid-template-columns: repeat(5, 200px); /* å¼·åˆ¶å¯¬åº¦ */
                overflow-x: auto; /* æ©«å‘æ²å‹• */
                padding-bottom: 5px;
                display: flex; /* æ”¹ç”¨ Flex ä»¥æ”¯æ´æ»‘å‹• */
            }
            .venue-card { flex: 0 0 100px; } /* å›ºå®šå¡ç‰‡å¯¬åº¦ */
            
            .betting-area { grid-template-columns: repeat(2, 1fr); } /* æ‰‹æ©Ÿæ”¹ç‚º2åˆ— */
            
            .bet-input-group { gap: 5px; }
            input[type="number"] { width: 80px; }
            
            #start-btn { width: 100% !important; margin-top: 10px; padding: 12px; font-size: 18px; }
            
            .info-panel { flex-direction: column; align-items: flex-start; gap: 5px; }
            .weather-info { width: 100%; text-align: right; border-top: 1px solid #ccc; padding-top: 5px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“± å‹•ç‰©å¤§è³½è·‘ ğŸ“±</h1>
    
    <div class="info-panel">
        <div class="funds-group">
            <div>ğŸ’° è³‡é‡‘: $<span id="funds">1000</span></div>
            <div id="relief-status" class="relief-info" style="display:none;">
                æ•‘æ¿Ÿ: <span id="relief-count">0</span>/10 æ¬¡ (<span id="timer-display"></span>)
            </div>
        </div>
        <div class="weather-info" id="weather-display">â˜€ï¸ å¤©æ°£: è¼‰å…¥ä¸­...</div>
    </div>

    <h3>1. é¸æ“‡å ´åœ°</h3>
    <div class="venue-selection" id="venue-list"></div>

    <h3>2. é¸æ“‡é¸æ‰‹</h3>
    <div class="betting-area" id="betting-area"></div>

    <div class="controls">
        <div class="bet-input-group">
            <button class="reset-btn" onclick="resetBet()">é‡ç½®</button>
            <button class="quick-btn minus" onclick="adjustBet(-500)">-500</button>
            <button class="quick-btn minus" onclick="adjustBet(-100)">-100</button>
            
            <input type="number" id="bet-amount" placeholder="è³­é‡‘" min="100" step="100" value="100" readonly>
            
            <button class="quick-btn" onclick="adjustBet(100)">+100</button>
            <button class="quick-btn" onclick="adjustBet(500)">+500</button>
        </div>
        <span class="min-bet-hint" id="min-bet-display">æœ€ä½ä¸‹æ³¨: $100</span>
        <button id="start-btn" onclick="startGame()" style="width: 200px; font-size: 18px; font-weight: bold;">ğŸ é–‹å§‹æ¯”è³½</button>
    </div>

    <div class="track-area" id="track-area"></div>

    <div class="log-area" id="game-log">
        <div>ç³»çµ±ï¼šå·²å•Ÿç”¨ã€Œé˜²åˆ·å±€ã€æ©Ÿåˆ¶ã€‚é‡æ–°æ•´ç†ç¶²é ä¸æœƒæ”¹è®Šè³ ç‡èˆ‡å¤©æ°£ã€‚</div>
    </div>

    <button id="dev-trigger-btn" onclick="toggleDevPanel()">ğŸ› ï¸ é–‹ç™¼è€…é¸é …</button>
    <div id="dev-panel">
        <h4>ğŸ”§ é–‹ç™¼è€…æ§åˆ¶å°</h4>
        <div class="dev-controls">
            <button class="dev-btn" onclick="devAddFunds()">ğŸ’° +1000 è³‡é‡‘</button>
            <button class="dev-btn danger" onclick="devResetMatch()">ğŸ”„ å¼·åˆ¶é‡ç½®æ¯”è³½</button>
            <button class="dev-btn" onclick="devSetWeather('æ™´å¤©')">â˜€ï¸ è¨­ç‚ºæ™´å¤©</button>
            <button class="dev-btn" onclick="devSetWeather('é›¨å¤©')">ğŸŒ§ï¸ è¨­ç‚ºé›¨å¤©</button>
            <button class="dev-btn" onclick="devSetWeather('å¤§é¢¨')">ğŸ’¨ è¨­ç‚ºå¤§é¢¨</button>
            <button class="dev-btn danger" onclick="exitDevMode()">ğŸšª é€€å‡ºé–‹ç™¼è€…æ¨¡å¼</button>
        </div>
        <div style="font-size:12px; margin-top:10px; color:#ccc;">
            * åœ¨é–‹ç™¼è€…æ¨¡å¼ä¸‹ï¼Œé»æ“Šä¸Šæ–¹çš„ã€Œå‹•ç‰©å¡ç‰‡ã€å¯ç›´æ¥ä¿®æ”¹è©²å‹•ç‰©è³ ç‡ã€‚
        </div>
    </div>
</div>

<script>
// --- 1. éŠæˆ²è³‡æ–™ ---
const ANIMAL_DATA = [
    { name: "é–ƒé›»å…”", icon: "ğŸ‡", fav: "æ™´å¤©" },
    { name: "æš´é¢¨é¦¬", icon: "ğŸ", fav: "æ™´å¤©" },
    { name: "æ…¢åé¾œ", icon: "ğŸ¢", fav: "é›¨å¤©" },
    { name: "è¡é‹’è±¹", icon: "ğŸ†", fav: "å¤§é¢¨" },
    { name: "æ‡¶æƒ°è²“", icon: "ğŸˆ", fav: "ç†±æµª" },
    { name: "æš´åŠ›ç†Š", icon: "ğŸ»", fav: "é›¨å¤©" },
    { name: "éˆæ´»çŒ´", icon: "ğŸ’", fav: "ç†±æµª" },
    { name: "å¦å…‹è±¬", icon: "ğŸ–", fav: "å¤§é¢¨" }
];

const VENUES = [
    { name: "æ–°æ‰‹è‰åœ°", length: 2000, minFunds: 0, eventProb: 0.005, desc: "å…è²»" },
    { name: "é€²éšæ³¥åœ°", length: 4000, minFunds: 500, eventProb: 0.010, desc: "$500+" },
    { name: "å°ˆæ¥­æ²™åœ°", length: 6000, minFunds: 1500, eventProb: 0.015, desc: "$1500+" },
    { name: "å¤§å¸«å±±è·¯", length: 8000, minFunds: 3000, eventProb: 0.020, desc: "$3000+" },
    { name: "å‚³å¥‡æµ·å²¸", length: 12000, minFunds: 5000, eventProb: 0.025, desc: "$5000+" }
];

const WEATHERS = [
    { name: "æ™´å¤©", effect: "normal" },
    { name: "é›¨å¤©", effect: "slippery" }, 
    { name: "å¤§é¢¨", effect: "resistance" },
    { name: "ç†±æµª", effect: "tired" }
];

const EVENTS = [
    { text: "åœä¸‹ä¾†åƒè‰ ğŸŒ¿", type: "stop", val: 1500 },
    { text: "åŠ é€Ÿè¡åˆºï¼ğŸ’¨", type: "speed", val: 1.5 },
    { text: "è¢«çŸ³é ­çµ†å€’ ğŸª¨", type: "stop", val: 1200 },
    { text: "æ»‘äº†ä¸€è·¤ ğŸŒ", type: "progress", val: 50 },
    { text: "é€†é¢¨æ¸›é€Ÿ ğŸŒ¬ï¸", type: "speed", val: 0.7 },
    { text: "é‹å¸¶é¬†äº† ğŸ‘Ÿ", type: "stop", val: 1000 },
    { text: "è¢«å°æ‰‹æ¨æ“  ğŸ˜¤", type: "stop", val: 800 },
    { text: "å–äº†èƒ½é‡é£²æ–™ ğŸ¥¤", type: "speed", val: 1.8 },
    { text: "è§€çœ¾æ­¡å‘¼ ğŸ‰", type: "speed", val: 1.3 },
    { text: "è‚šå­ç—› ğŸš½", type: "stop", val: 2500 },
    { text: "è¿·è·¯äº†... ğŸ—ºï¸", type: "progress", val: -50 },
    { text: "è…³æŠ½ç­‹ ğŸ˜«", type: "speed", val: 0.4 },
    { text: "æ’¿åˆ°å™´å°„èƒŒåŒ…ï¼ğŸš€", type: "speed", val: 3.0 },
    { text: "æ­ä¸Šäº†è¨ˆç¨‹è»Š ğŸš•", type: "speed", val: 2.5 },
    { text: "ç™¼ç¾ç§˜å¯†æ·å¾‘ ğŸ•³ï¸", type: "progress", val: 300 },
    { text: "è¢«UFOæ¨äº†ä¸€æŠŠ ğŸ›¸", type: "speed", val: 3.5 },
    { text: "æ‰é€²æ•´äººé™·é˜± ğŸ•³ï¸", type: "stop", val: 4000 },
    { text: "é–‹å•Ÿç‹‚æš´æ¨¡å¼ âš¡", type: "speed", val: 2.2 }
];

// --- 2. è®Šæ•¸ ---
let funds = 1000;
let currentVenueIndex = 0;
let currentMinBet = 100; 
let currentWeather = null;
let animals = [];
let selectedAnimalIndex = -1;
let isRacing = false;
let raceInterval = null;
let reliefNextTime = null; 
let reliefCount = 0;
let isDevMode = false; // é–‹ç™¼è€…æ¨¡å¼æ——æ¨™

window.onload = function() {
    loadFundsData();
    // å˜—è©¦è¼‰å…¥æœªå®Œæˆçš„æ¯”è³½ç‹€æ…‹
    let hasSavedMatch = loadMatchState();
    
    // å¦‚æœæ²’æœ‰å­˜æª”ï¼Œæ‰é€²è¡Œåˆå§‹åŒ–
    if (!hasSavedMatch) {
        selectVenue(0); 
        resetMatch(true); // true è¡¨ç¤ºç”Ÿæˆæ–°æ•¸æ“š
    } else {
        log("è®€å–åˆ°æœªå®Œæˆçš„è³½äº‹è³‡æ–™ï¼Œå·²æ¢å¾©å¤©æ°£èˆ‡è³ ç‡ã€‚");
    }
    
    setInterval(checkReliefSystem, 1000); 
};

// --- 3. Class (æ”¯æ´å­˜æª”æ¢å¾©) ---
class Animal {
    // å»ºæ§‹å­æ–°å¢ savedOdds åƒæ•¸
    constructor(id, data, venueLength, weather, savedOdds = null) {
        this.id = id;
        this.name = data.name;
        this.icon = data.icon;
        this.favWeather = data.fav;
        
        if (savedOdds) {
            this.odds = savedOdds; // ä½¿ç”¨å­˜æª”è³ ç‡
        } else {
            this.odds = (Math.random() * (10 - 1.1) + 1.1).toFixed(2); // ç”Ÿæˆæ–°è³ ç‡
        }
        
        // é‡æ–°è¨ˆç®—é€Ÿåº¦ (ç¢ºä¿é‚è¼¯ä¸€è‡´)
        this.recalcSpeed(venueLength, weather);

        this.position = 0; 
        this.status = ""; 
        this.finished = false;
        this.finishOrder = 0;
        this.speedBoostTimer = null;
    }

    recalcSpeed(venueLength, weather) {
        const targetFrames = 600; 
        const avgSpeed = venueLength / targetFrames;
        const minOdds = 1.1;
        const maxOdds = 10.0;
        
        // é€Ÿåº¦è¨ˆç®—
        let oddsRatio = (this.odds - minOdds) / (maxOdds - minOdds);
        let speedFactor = 1.25 - (oddsRatio * 0.5); 
        
        // ç‚ºäº†è®“ Dev æ¨¡å¼ä¿®æ”¹è³ ç‡æ™‚é€Ÿåº¦èƒ½å³æ™‚åæ‡‰ï¼Œæˆ‘å€‘ç¨å¾®ç°¡åŒ–éš¨æ©Ÿå› å­
        // åœ¨æ¢å¾©æ¨¡å¼ä¸‹ï¼Œæˆ‘å€‘ç„¡æ³•å®Œå…¨é‚„åŸç•¶æ™‚çš„éš¨æ©Ÿæµ®å‹•ï¼Œé™¤éä¹Ÿå­˜èµ·ä¾†
        // é€™è£¡æˆ‘å€‘å–ä¸€å€‹å›ºå®šçš„å°éš¨æ©Ÿï¼Œé¿å…å¤ªéæ­»æ¿
        speedFactor += (Math.random() * 0.05 - 0.025);

        this.baseSpeed = avgSpeed * speedFactor;

        this.isFavWeather = (weather.name === this.favWeather);
        if (this.isFavWeather) {
            this.baseSpeed *= 1.05; 
        }
        this.currentSpeed = this.baseSpeed;
    }

    update(venueLength, weather, eventProb) {
        if (this.finished) return;

        let weatherMod = 1;
        if (weather.name === "é›¨å¤©" && Math.random() < 0.01) this.triggerEvent({text:"æ‰“æ»‘", type:"stop", val:500});
        if (weather.name === "å¤§é¢¨") weatherMod = 0.9;
        
        if (Math.random() < eventProb) {
            let evt = EVENTS[Math.floor(Math.random() * EVENTS.length)];
            this.triggerEvent(evt);
        }

        this.position += this.currentSpeed * weatherMod;
        
        if (this.position >= venueLength) {
            this.position = venueLength;
            this.finished = true;
        }
    }

    triggerEvent(evt) {
        log(`${this.name} ${evt.text}`);
        this.status = evt.text.split(" ")[0];
        setTimeout(() => { this.status = ""; }, 1500);

        if (evt.type === "speed") {
            if(this.speedBoostTimer) {
                clearTimeout(this.speedBoostTimer);
                this.currentSpeed = this.baseSpeed;
            }
            this.currentSpeed = this.baseSpeed * evt.val;
            this.speedBoostTimer = setTimeout(() => { 
                this.currentSpeed = this.baseSpeed; 
                this.speedBoostTimer = null;
            }, 2000);
        } else if (evt.type === "stop") {
            this.currentSpeed = 0;
            setTimeout(() => { this.currentSpeed = this.baseSpeed; }, evt.val);
        } else if (evt.type === "progress") {
            this.position += evt.val;
        }
    }
}

// --- 4. å­˜æª”èˆ‡é˜²åˆ·å±€æ©Ÿåˆ¶ ---

function saveMatchState() {
    // åªå„²å­˜é—œéµè³‡æ–™ï¼šå¤©æ°£ã€æ¯éš»å‹•ç‰©çš„è³ ç‡ã€ç•¶å‰å ´åœ°
    let state = {
        weatherIdx: WEATHERS.findIndex(w => w.name === currentWeather.name),
        venueIdx: currentVenueIndex,
        animalOdds: animals.map(a => a.odds)
    };
    localStorage.setItem('raceGameMatchState', JSON.stringify(state));
}

function loadMatchState() {
    let saved = localStorage.getItem('raceGameMatchState');
    if (!saved) return false;

    try {
        let state = JSON.parse(saved);
        
        // æ¢å¾©å ´åœ°
        selectVenue(state.venueIdx);
        
        // æ¢å¾©å¤©æ°£
        currentWeather = WEATHERS[state.weatherIdx];
        document.getElementById('weather-display').innerText = `${currentWeather.name === 'æ™´å¤©' ? 'â˜€ï¸' : currentWeather.name === 'é›¨å¤©' ? 'ğŸŒ§ï¸' : 'ğŸ’¨'} å¤©æ°£: ${currentWeather.name}`;
        
        // æ¢å¾©å‹•ç‰©èˆ‡è³ ç‡
        animals = [];
        let venueLen = VENUES[currentVenueIndex].length;
        
        // é‡ç¹ª UI
        let bettingHTML = "";
        let trackHTML = "";

        for(let i=0; i<8; i++) {
            let data = ANIMAL_DATA[i];
            let savedOdd = state.animalOdds[i]; // å–å‡ºå­˜æª”è³ ç‡
            let ani = new Animal(i, data, venueLen, currentWeather, savedOdd);
            animals.push(ani);

            let favInfo = ani.isFavWeather ? 
                `<div class="fav-weather" style="color:red; font-weight:bold;">ğŸ”¥ å¤©æ°£å„ªå‹¢ï¼</div>` : 
                `<div class="fav-weather">å–œå¥½: ${ani.favWeather}</div>`;

            bettingHTML += `
                <div class="bet-card" id="bet-${i}" onclick="handleAnimalClick(${i})">
                    <div style="font-size:20px">${ani.icon} ${ani.name}</div>
                    ${favInfo}
                    <div class="odds-text" id="odds-display-${i}">x${ani.odds}</div>
                </div>
            `;

            trackHTML += `
                <div class="lane">
                    <div class="lane-name">${ani.icon} ${ani.name}</div>
                    <div class="progress-bar" id="bar-${i}">
                         <div class="animal-icon">${ani.icon}</div>
                </div>
                <div class="status-text" id="status-${i}"></div>
            </div>`;
        }

        document.getElementById('betting-area').innerHTML = bettingHTML;
        document.getElementById('track-area').innerHTML = trackHTML;
        
        selectedAnimalIndex = -1;
        document.getElementById('start-btn').disabled = false;
        
        // å¦‚æœæ˜¯ Dev æ¨¡å¼ï¼Œè¦æ›´æ–°é‚Šæ¡†
        if(isDevMode) updateDevUI();

        return true;
    } catch (e) {
        console.error("Save load failed", e);
        return false;
    }
}

function clearMatchState() {
    localStorage.removeItem('raceGameMatchState');
}

// --- 5. é‚è¼¯èˆ‡æ§åˆ¶ ---

function adjustBet(val) {
    if(isRacing) return;
    let input = document.getElementById('bet-amount');
    let current = parseInt(input.value) || 0;
    let newVal = current + val;
    if (newVal < currentMinBet) newVal = currentMinBet;
    input.value = newVal;
}

function resetBet() {
    if(isRacing) return;
    document.getElementById('bet-amount').value = currentMinBet;
}

function renderVenues() {
    let html = "";
    VENUES.forEach((v, idx) => {
        let isLocked = funds < v.minFunds;
        let isActive = idx === currentVenueIndex;
        
        // é¿å…é‡æ–°æ¸²æŸ“æ™‚åˆ‡æ›å ´åœ°å°è‡´å­˜æª”ä¸ä¸€è‡´ï¼Œé€™è£¡åªè² è²¬ UI
        let chaos = Math.floor(v.eventProb * 1000);

        html += `
            <div class="venue-card ${isLocked ? 'locked' : ''} ${isActive ? 'active' : ''}" 
                 onclick="${isLocked ? '' : `selectVenue(${idx})`}">
                ${isLocked ? '<div class="lock-icon">ğŸ”’</div>' : '<div class="lock-icon">ğŸŒ²</div>'}
                <div class="venue-name">${v.name}</div>
                <div class="venue-fee">${v.length}m</div>
                <div class="venue-fee" style="color:${isLocked ? 'red' : 'green'}">${v.desc}</div>
                <div class="chaos-level">âš¡${chaos}</div>
            </div>
        `;
    });
    document.getElementById('venue-list').innerHTML = html;
}

function selectVenue(index) {
    if (isRacing) return;
    currentVenueIndex = index;
    
    let venueData = VENUES[index];
    currentMinBet = venueData.minFunds > 0 ? venueData.minFunds : 100;
    
    let input = document.getElementById('bet-amount');
    if(parseInt(input.value) < currentMinBet) input.value = currentMinBet;
    input.min = currentMinBet;
    
    document.getElementById('min-bet-display').innerText = `æœ€ä½ä¸‹æ³¨: $${currentMinBet}`;
    
    renderVenues();
    // åˆ‡æ›å ´åœ°ä¹Ÿç®—æ˜¯æ”¹è®Šæ¯”è³½æ¢ä»¶ï¼Œéœ€è¦æ›´æ–°å­˜æª” (ä½†ä¸é‡ç½®è³ ç‡)
    // ä½†å› ç‚ºé€Ÿåº¦èˆ‡å ´åœ°é•·åº¦æœ‰é—œï¼Œåˆ‡æ›å ´åœ°æ‡‰è©²è¦é‡ç®—é€Ÿåº¦
    // é€™è£¡ç‚ºäº†ç°¡å–®ï¼Œåˆ‡æ›å ´åœ°ä¸å¼·åˆ¶é‡ç½®è³ ç‡ï¼Œä½†è¦é‡ç®— Animal çš„ baseSpeed
    if(animals.length > 0) {
        animals.forEach(ani => ani.recalcSpeed(venueData.length, currentWeather));
        saveMatchState(); // æ›´æ–°å­˜æª”ä¸­çš„å ´åœ°
    }
}

// resetMatch å¢åŠ åƒæ•¸ isForceNew
function resetMatch(isForceNew = false) {
    // 1. éš¨æ©Ÿç”Ÿæˆæ–°å¤©æ°£
    currentWeather = WEATHERS[Math.floor(Math.random() * WEATHERS.length)];
    document.getElementById('weather-display').innerText = `${currentWeather.name === 'æ™´å¤©' ? 'â˜€ï¸' : currentWeather.name === 'é›¨å¤©' ? 'ğŸŒ§ï¸' : 'ğŸ’¨'} å¤©æ°£: ${currentWeather.name}`;
    
    animals = [];
    let bettingHTML = "";
    let trackHTML = "";
    let venueLen = VENUES[currentVenueIndex].length;
    
    for(let i=0; i<8; i++) {
        let data = ANIMAL_DATA[i];
        // ç”¢ç”Ÿæ–°å‹•ç‰© (ä¸å‚³å…¥ savedOddsï¼Œå°±æœƒéš¨æ©Ÿç”Ÿæˆ)
        let ani = new Animal(i, data, venueLen, currentWeather);
        animals.push(ani);

        let favInfo = ani.isFavWeather ? 
            `<div class="fav-weather" style="color:red; font-weight:bold;">ğŸ”¥ å¤©æ°£å„ªå‹¢ï¼</div>` : 
            `<div class="fav-weather">å–œå¥½: ${ani.favWeather}</div>`;

        bettingHTML += `
            <div class="bet-card" id="bet-${i}" onclick="handleAnimalClick(${i})">
                <div style="font-size:20px">${ani.icon} ${ani.name}</div>
                ${favInfo}
                <div class="odds-text" id="odds-display-${i}">x${ani.odds}</div>
            </div>
        `;

        trackHTML += `
            <div class="lane">
                <div class="lane-name">${ani.icon} ${ani.name}</div>
                <div class="progress-bar" id="bar-${i}">
                     <div class="animal-icon">${ani.icon}</div>
                </div>
                <div class="status-text" id="status-${i}"></div>
            </div>
        `;
    }

    document.getElementById('betting-area').innerHTML = bettingHTML;
    document.getElementById('track-area').innerHTML = trackHTML;
    
    selectedAnimalIndex = -1;
    document.getElementById('start-btn').disabled = false;

    // é—œéµï¼šç”¢ç”Ÿå®Œç•¢å¾Œç«‹åˆ»å­˜æª”
    saveMatchState();
    if(isDevMode) updateDevUI();
}

// çµ±ä¸€è™•ç†é»æ“Šå‹•ç‰© (åŒ…å«æ™®é€šé¸æ“‡èˆ‡ Dev ä¿®æ”¹)
function handleAnimalClick(index) {
    if (isDevMode) {
        devModifyOdds(index);
    } else {
        selectAnimal(index);
    }
}

function selectAnimal(index) {
    if (isRacing) return;
    document.querySelectorAll('.bet-card').forEach(c => c.classList.remove('selected'));
    selectedAnimalIndex = index;
    document.getElementById(`bet-${index}`).classList.add('selected');
}

function startGame() {
    let amount = parseInt(document.getElementById('bet-amount').value);
    
    if (selectedAnimalIndex === -1) { alert("è«‹å…ˆé¸æ“‡ä¸€éš»å‹•ç‰©ï¼"); return; }
    if (isNaN(amount)) { alert("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡ï¼"); return; }
    if (amount < currentMinBet) { alert(`æ­¤å ´åœ°æœ€ä½ä¸‹æ³¨é‡‘é¡ç‚º $${currentMinBet}ï¼`); return; }
    if (amount % 100 !== 0) { alert("ä¸‹æ³¨é‡‘é¡å¿…é ˆæ˜¯ 100 çš„å€æ•¸ï¼"); return; }
    if (amount > funds) { alert("è³‡é‡‘ä¸è¶³ï¼"); return; }

    funds -= amount;
    updateFundsDisplay();
    isRacing = true;
    document.getElementById('start-btn').disabled = true;
    document.querySelectorAll('button').forEach(b => b.disabled = true);
    document.querySelectorAll('.bet-card').forEach(c => c.classList.add('disabled'));
    document.querySelectorAll('.venue-card').forEach(c => c.style.pointerEvents = 'none');

    let venue = VENUES[currentVenueIndex];
    log(`æ¯”è³½é–‹å§‹ï¼å ´åœ°ï¼š${venue.name}ï¼Œä¸‹æ³¨ $${amount}ã€‚`);

    let finishedCount = 0;
    
    raceInterval = setInterval(() => {
        let allFinished = true;
        
        animals.forEach(ani => {
            ani.update(venue.length, currentWeather, venue.eventProb);
            
            let pct = (ani.position / venue.length) * 100;
            if(pct > 100) pct = 100;
            document.getElementById(`bar-${ani.id}`).style.width = `${pct}%`;
            document.getElementById(`status-${ani.id}`).innerText = ani.status;

            if (!ani.finished) {
                allFinished = false;
            } else if (ani.finishOrder === 0) {
                finishedCount++;
                ani.finishOrder = finishedCount;
                log(`ç¬¬ ${finishedCount} å: ${ani.name}`);
            }
        });

        if (allFinished) {
            endGame(amount);
        }

    }, 50); 
}

function endGame(betAmount) {
    clearInterval(raceInterval);
    isRacing = false;
    document.querySelectorAll('button').forEach(b => b.disabled = false);
    document.getElementById('start-btn').disabled = true;
    document.querySelectorAll('.venue-card').forEach(c => c.style.pointerEvents = 'auto');
    
    let winner = animals.find(a => a.finishOrder === 1);
    let playerChoice = animals[selectedAnimalIndex];

    log(`ğŸ† å† è»æ˜¯ï¼š${winner.name}`);

    if (playerChoice.id === winner.id) {
        let winAmount = Math.ceil(betAmount * playerChoice.odds);
        funds += winAmount;
        log(`æ­å–œï¼è´å¾— $${winAmount} (è³ ç‡ ${playerChoice.odds})`);
        alert(`æ­å–œï¼ä½ è´äº† $${winAmount}`);
    } else {
        log(`å¯æƒœï¼ä½ çš„ ${playerChoice.name} ç²å¾—ç¬¬ ${playerChoice.finishOrder} åã€‚`);
    }

    updateFundsDisplay();
    
    // é—œéµï¼šæ¯”è³½çµæŸï¼Œæ¸…é™¤å­˜æª”ï¼Œå…è¨±ä¸‹ä¸€å ´ç”Ÿæˆæ–°æ•¸æ“š
    clearMatchState();
    
    setTimeout(() => {
        resetMatch(true); // ç”¢ç”Ÿä¸‹ä¸€å ´
    }, 3000);
}

// --- 6. é–‹ç™¼è€…æ¨¡å¼ ---

function toggleDevPanel() {
    if (isDevMode) return; // å·²ç¶“é–‹å•Ÿå°±ä¸ç”¨å†æŒ‰
    let pass = prompt("è«‹è¼¸å…¥é–‹ç™¼è€…ä»£ç¢¼:");
    if (pass === "axin666") {
        isDevMode = true;
        document.getElementById('dev-panel').style.display = 'block';
        document.getElementById('dev-trigger-btn').style.display = 'none';
        updateDevUI();
        alert("é–‹ç™¼è€…æ¨¡å¼å·²å•Ÿç”¨ï¼");
        log("[ç³»çµ±] é–‹ç™¼è€…æ¨¡å¼å·²å•Ÿç”¨");
    } else if (pass !== null) {
        alert("å¯†ç¢¼éŒ¯èª¤");
    }
}

function exitDevMode() {
    isDevMode = false;
    document.getElementById('dev-panel').style.display = 'none';
    document.getElementById('dev-trigger-btn').style.display = 'inline-block';
    updateDevUI(); // ç§»é™¤é‚Šæ¡†
    log("[ç³»çµ±] é–‹ç™¼è€…æ¨¡å¼å·²é—œé–‰");
}

function devAddFunds() {
    funds += 1000;
    updateFundsDisplay();
    log("[DEV] è³‡é‡‘ +1000");
}

function devResetMatch() {
    if(isRacing) return;
    clearMatchState();
    resetMatch(true);
    log("[DEV] å¼·åˆ¶é‡ç½®æ¯”è³½");
}

function devSetWeather(name) {
    if(isRacing) return;
    let w = WEATHERS.find(x => x.name === name);
    if(w) {
        currentWeather = w;
        document.getElementById('weather-display').innerText = `${currentWeather.name === 'æ™´å¤©' ? 'â˜€ï¸' : currentWeather.name === 'é›¨å¤©' ? 'ğŸŒ§ï¸' : 'ğŸ’¨'} å¤©æ°£: ${currentWeather.name}`;
        // å¤©æ°£æ”¹è®Šï¼Œé‡æ–°è¨ˆç®—å‹•ç‰©é€Ÿåº¦
        animals.forEach(ani => ani.recalcSpeed(VENUES[currentVenueIndex].length, currentWeather));
        // æ›´æ–° UI ä¸Šçš„å¤©æ°£å„ªå‹¢é¡¯ç¤º
        updateAnimalCardsUI();
        saveMatchState();
        log(`[DEV] å¤©æ°£å¼·åˆ¶æ”¹ç‚º ${name}`);
    }
}

function devModifyOdds(index) {
    let ani = animals[index];
    let newOdds = prompt(`ä¿®æ”¹ ${ani.name} çš„è³ ç‡ (ç›®å‰: ${ani.odds})`, ani.odds);
    
    if (newOdds !== null && !isNaN(newOdds) && newOdds > 0) {
        ani.odds = parseFloat(newOdds).toFixed(2);
        // é‡æ–°è¨ˆç®—é€Ÿåº¦
        ani.recalcSpeed(VENUES[currentVenueIndex].length, currentWeather);
        
        // æ›´æ–° UI
        document.getElementById(`odds-display-${index}`).innerText = `x${ani.odds}`;
        saveMatchState();
        log(`[DEV] ${ani.name} è³ ç‡ä¿®æ”¹ç‚º ${ani.odds}`);
    }
}

function updateDevUI() {
    // è®“å‹•ç‰©å¡ç‰‡é¡¯ç¤ºã€Œå¯ç·¨è¼¯ã€ç‹€æ…‹
    let cards = document.querySelectorAll('.bet-card');
    cards.forEach(c => {
        if (isDevMode) c.classList.add('dev-active-border');
        else c.classList.remove('dev-active-border');
    });
}

function updateAnimalCardsUI() {
    // ç•¶å¤©æ°£æ”¹è®Šæ™‚ï¼Œé‡æ–°æ¸²æŸ“å¡ç‰‡ä¸Šçš„ã€Œå¤©æ°£å„ªå‹¢ã€æ–‡å­—
    animals.forEach((ani, i) => {
        let card = document.getElementById(`bet-${i}`);
        // é€™è£¡æ¯”è¼ƒæš´åŠ›ç›´æ¥æ‰¾ divï¼Œå¯¦éš›é–‹ç™¼å¯ç”¨æ›´å„ªé›…çš„æ–¹å¼
        // ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘é‡æ–°ç”Ÿæˆé‚£å€‹å°å€å¡Š
        let favInfo = ani.isFavWeather ? 
            `<div class="fav-weather" style="color:red; font-weight:bold;">ğŸ”¥ å¤©æ°£å„ªå‹¢ï¼</div>` : 
            `<div class="fav-weather">å–œå¥½: ${ani.favWeather}</div>`;
        
        // å–ä»£ä¸­é–“é‚£å€‹ div (ç¬¬2å€‹ child)
        card.children[1].outerHTML = favInfo;
    });
}

// --- 7. è³‡é‡‘èˆ‡æ•‘æ¿Ÿé‡‘ç³»çµ± ---

function updateFundsDisplay() {
    document.getElementById('funds').innerText = funds;
    localStorage.setItem('raceGameFunds', funds);
    if (reliefNextTime) localStorage.setItem('raceGameReliefTime', reliefNextTime);
    else localStorage.removeItem('raceGameReliefTime');
    localStorage.setItem('raceGameReliefCount', reliefCount);
    renderVenues(); 
    checkReliefUI(); 
}

function loadFundsData() {
    let savedFunds = localStorage.getItem('raceGameFunds');
    let savedTime = localStorage.getItem('raceGameReliefTime');
    let savedCount = localStorage.getItem('raceGameReliefCount');

    if (savedFunds !== null) funds = parseInt(savedFunds);
    if (savedTime !== null) reliefNextTime = parseInt(savedTime);
    if (savedCount !== null) reliefCount = parseInt(savedCount);
}

function checkReliefSystem() {
    if (funds <= 0 && reliefNextTime === null) {
        reliefNextTime = Date.now() + 30 * 60 * 1000; 
        reliefCount = 0; 
        updateFundsDisplay();
        log("ç ´ç”¢ï¼æ•‘æ¿Ÿè¨ˆç•«å•Ÿå‹•ã€‚");
        return;
    }

    if (reliefNextTime !== null) {
        let now = Date.now();
        while (now >= reliefNextTime && reliefCount < 10) {
            funds += 100;
            reliefCount++;
            reliefNextTime += 30 * 60 * 1000; 
            log(`æ”¶åˆ°æ•‘æ¿Ÿé‡‘ $100ï¼(ç¬¬ ${reliefCount}/10 æ¬¡)`);
        }
        if (reliefCount >= 10) {
            reliefNextTime = null; 
            log("æ•‘æ¿Ÿé‡‘å·²å…¨æ•¸ç™¼æ”¾å®Œç•¢ã€‚");
        }
        updateFundsDisplay();
    }
}

function checkReliefUI() {
    let panel = document.getElementById('relief-status');
    let timerDisplay = document.getElementById('timer-display');
    let countDisplay = document.getElementById('relief-count');

    if (funds <= 0 || (reliefNextTime !== null && reliefCount < 10)) {
        panel.style.display = 'block';
        countDisplay.innerText = reliefCount;

        if (reliefNextTime) {
            let diff = reliefNextTime - Date.now();
            if (diff > 0) {
                let mm = Math.floor(diff / 60000);
                let ss = Math.floor((diff % 60000) / 1000);
                timerDisplay.innerText = `${mm}åˆ†${ss}ç§’`;
            } else {
                timerDisplay.innerText = "ç™¼æ”¾ä¸­...";
            }
        }
    } else {
        panel.style.display = 'none';
    }
}

function log(msg) {
    let logArea = document.getElementById('game-log');
    let p = document.createElement('div');
    p.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logArea.prepend(p);
}
</script>

</body>
</html>