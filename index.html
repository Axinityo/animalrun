<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‹•ç‰©å¤§è³½è·‘</title>
    <style>
        /* --- CSS è®Šæ•¸ç³»çµ± (ä¸»é¡Œé…è‰²) --- */
        :root {
            /* æ˜äº®æ¨¡å¼ (é è¨­) */
            --bg-body: #f0f2f5;
            --bg-container: #ffffff;
            --text-main: #333333;
            --text-muted: #666666;
            --bg-panel: #e0e7ff;
            --border-panel: #4f46e5;
            --bg-card: #ffffff;
            --border-card: #cccccc;
            --bg-control: #f8f9fa;
            --input-bg: #ffffff;
            --input-border: #ddd;
            --input-text: #333;
            --shadow: rgba(0,0,0,0.1);
            --hover-bg: #f9f9f9;
            --card-owned-bg: #f0fff4;
            --card-owned-border: #28a745;
            --card-selected-bg: #d1fae5;
            --card-selected-border: #10b981;
            --venue-active-bg: #fffbeb;
            --venue-active-border: #f59e0b;
            --achieve-bg: #eeeeee;
            --achieve-unlocked-bg: #fffbe6;
            --danger-zone-bg: #fff5f5;
        }

        /* æ·±è‰²æ¨¡å¼è¦†å¯« */
        body.dark-mode {
            --bg-body: #121212;
            --bg-container: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #aaaaaa;
            --bg-panel: #2c2c54;
            --border-panel: #6366f1;
            --bg-card: #2d2d2d;
            --border-card: #444444;
            --bg-control: #2d2d2d;
            --input-bg: #383838;
            --input-border: #555;
            --input-text: #fff;
            --shadow: rgba(0,0,0,0.5);
            --hover-bg: #3a3a3a;
            --card-owned-bg: #1e3a29;
            --card-owned-border: #28a745;
            --card-selected-bg: #1a4731;
            --card-selected-border: #10b981;
            --venue-active-bg: #4a3e1b;
            --venue-active-border: #f59e0b;
            --achieve-bg: #333333;
            --achieve-unlocked-bg: #4a4a2e;
            --danger-zone-bg: #3c2a2a;
        }

        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: var(--bg-body); padding: 10px; margin: 0; color: var(--text-main); transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 1000px; margin: 0 auto; background: var(--bg-container); padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow); position: relative; transition: background-color 0.3s; }
        h1 { margin: 10px 0; font-size: 24px; text-align: center; color: var(--text-main); }
        h3 { margin: 15px 0 10px; font-size: 16px; border-left: 4px solid #007bff; padding-left: 10px; display: flex; justify-content: space-between; align-items: center; color: var(--text-main); }

        #theme-toggle-btn {
            position: absolute; top: 15px; right: 15px;
            background: none; border: 2px solid var(--text-muted); color: var(--text-main);
            border-radius: 20px; padding: 5px 12px; font-size: 14px; cursor: pointer; transition: 0.3s; z-index: 10;
        }
        #theme-toggle-btn:hover { background: var(--hover-bg); }

        #bonus-banner {
            display: none;
            background: linear-gradient(45deg, #ffc107, #ff5722, #ffc107);
            color: white; text-align: center; font-size: 18px; font-weight: bold;
            padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 2px solid #fff;
            box-shadow: 0 0 10px #ffc107; animation: glow 1s infinite alternate; text-shadow: 1px 1px 2px black;
        }

        .info-panel { display: flex; flex-wrap: wrap; justify-content: space-between; margin-bottom: 15px; padding: 12px; background: var(--bg-panel); border-radius: 8px; font-weight: bold; border: 2px solid var(--border-panel); align-items: center; color: var(--text-main); }
        .funds-group { display: flex; flex-direction: column; }
        .relief-info { color: #d97706; font-size: 12px; margin-top: 5px; animation: pulse 2s infinite; }
        
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid var(--border-card); padding-bottom: 5px; overflow-x: auto; }
        .nav-btn { background: none; border: none; padding: 8px 15px; font-size: 16px; font-weight: bold; color: var(--text-muted); cursor: pointer; white-space: nowrap; }
        .nav-btn.active { color: #007bff; border-bottom: 3px solid #007bff; margin-bottom: -7px; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-control); border: 1px solid var(--border-card); padding: 10px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 20px; font-weight: bold; color: #007bff; margin: 5px 0; }
        .stat-label { font-size: 12px; color: var(--text-muted); }
        
        .list-group { display: flex; flex-direction: column; gap: 5px; }
        .list-item { display: flex; justify-content: space-between; padding: 8px; background: var(--bg-card); border-bottom: 1px solid var(--border-card); font-size: 14px; color: var(--text-main); }
        .list-item:last-child { border-bottom: none; }
        .bar-container { width: 100px; height: 10px; background: var(--bg-control); border-radius: 5px; overflow: hidden; margin-left: 10px; }
        .bar-fill { height: 100%; background: #28a745; }

        .store-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .item-card { border: 1px solid var(--border-card); padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s; background: var(--bg-card); position: relative; color: var(--text-main); }
        .item-card:hover { transform: translateY(-2px); box-shadow: 0 2px 5px var(--shadow); background: var(--hover-bg); }
        .item-card.owned { border-color: var(--card-owned-border); background: var(--card-owned-bg); }
        .item-card.selected { border-color: var(--card-selected-border); background: var(--card-selected-bg); box-shadow: 0 0 0 2px var(--card-selected-border); }
        .item-icon { font-size: 24px; display: block; margin-bottom: 5px; }
        .item-name { font-weight: bold; font-size: 14px; }
        .item-desc { font-size: 11px; color: var(--text-muted); margin: 5px 0; height: 30px; }
        .item-price { color: #d97706; font-weight: bold; font-size: 13px; }
        .item-count { position: absolute; top: 5px; right: 5px; background: #333; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 11px; line-height: 24px; }
        .buy-btn { width: 100%; margin-top: 5px; background: #28a745; color: white; border: none; padding: 5px; border-radius: 4px; cursor: pointer; }
        .buy-btn:hover { background: #218838; }
        .buy-btn:disabled { background: #ccc; cursor: not-allowed; }

        .achieve-list { display: grid; grid-template-columns: 1fr; gap: 8px; max-height: 400px; overflow-y: auto; }
        .achieve-item { display: flex; align-items: center; padding: 10px; background: var(--achieve-bg); border-radius: 6px; border-left: 4px solid #aaa; color: var(--text-main); }
        .achieve-item.unlocked { background: var(--achieve-unlocked-bg); border-left-color: #ffc107; }
        .achieve-icon { font-size: 24px; margin-right: 10px; opacity: 0.3; }
        .achieve-item.unlocked .achieve-icon { opacity: 1; }
        .achieve-info { flex: 1; }
        .achieve-title { font-weight: bold; font-size: 14px; }
        .achieve-desc { font-size: 11px; color: var(--text-muted); }

        .venue-selection { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .venue-card { background: var(--bg-card); border: 2px solid var(--border-card); padding: 8px; border-radius: 8px; text-align: center; cursor: pointer; min-width: 100px; flex-shrink: 0; color: var(--text-main); }
        .venue-card.active { border-color: var(--venue-active-border); background: var(--venue-active-bg); }
        .venue-card.locked { opacity: 0.6; cursor: not-allowed; }
        .venue-fee { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

        .track-area { margin: 15px 0; border: 2px solid #333; padding: 5px; background: #555; border-radius: 5px; position: relative; height: 380px; overflow: hidden; }
        .lane { position: absolute; left: 5px; right: 5px; height: 36px; background: #333; padding: 2px; border-radius: 4px; transition: top 0.5s ease-in-out; z-index: 1; }
        .lane-rank-indicator { position: absolute; left: -35px; top: 50%; transform: translateY(-50%); color: var(--text-main); font-weight: bold; font-size: 12px; width: 30px; text-align: right; display: none; }
        .lane-name { color: white; position: absolute; left: 5px; top: 50%; transform: translateY(-50%); z-index: 2; font-size: 12px; text-shadow: 1px 1px 2px black; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); width: 0%; border-radius: 4px; transition: width 0.05s linear; position: relative; }
        .animal-icon { position: absolute; right: -12px; top: -6px; font-size: 22px; transition: right 0.05s linear; }
        .status-text { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); color: yellow; font-size: 10px; font-weight: bold; text-shadow: 1px 1px 2px black;}

        .betting-area { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
        .bet-card { border: 1px solid var(--border-card); padding: 8px; border-radius: 5px; text-align: center; cursor: pointer; position: relative; background: var(--bg-card); color: var(--text-main); }
        .bet-card.selected { background: var(--card-selected-bg); border-color: var(--card-selected-border); border-width: 2px; }
        .bet-card.disabled { opacity: 0.6; cursor: not-allowed; }
        .odds-text { color: #dc3545; font-weight: bold; font-size:16px; } 
        .fav-weather { font-size: 11px; color: var(--text-muted); margin-top: 2px; background: var(--bg-control); border-radius: 4px; padding: 2px;}

        /* --- æ§åˆ¶å€ --- */
        .controls { text-align: center; margin-top: 15px; background: var(--bg-control); padding: 15px; border-radius: 8px; }
        .bet-input-group { margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 4px; flex-wrap: wrap; }
        
        button { padding: 8px 10px; font-size: 14px; cursor: pointer; border: none; border-radius: 5px; touch-action: manipulation; font-weight: bold; transition: 0.2s; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-minus { background-color: #dc3545 !important; color: #ffffff !important; }
        .btn-minus:hover { background-color: #bb2d3b !important; }

        .btn-plus { background-color: #28a745 !important; color: #ffffff !important; }
        .btn-plus:hover { background-color: #218838 !important; }

        .btn-plus-lg { background-color: #198754 !important; color: #ffffff !important; } 
        .btn-plus-lg:hover { background-color: #157347 !important; }

        .btn-reset { background-color: #6c757d !important; color: #ffffff !important; }
        .btn-reset:hover { background-color: #5c636a !important; }

        .btn-allin { background: linear-gradient(45deg, #ffc107, #fd7e14) !important; color: #000 !important; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-allin:hover { filter: brightness(1.1); }

        .start-btn { background-color: #007bff !important; color: #ffffff !important; width: 200px; font-size: 18px; font-weight: bold; }
        .start-btn:disabled { background-color: #ccc !important; }
        
        .instant-end-btn { background-color: #6f42c1 !important; color: #ffffff !important; width: 100%; margin-top: 10px; font-weight: bold; display: none; animation: popIn 0.3s; }

        .danger-zone { margin-top: 30px; padding: 15px; border: 2px dashed #dc3545; border-radius: 8px; text-align: center; background: var(--danger-zone-bg); }
        .hard-reset-btn { background-color: #dc3545 !important; color: #ffffff !important; font-weight: bold; padding: 10px 20px; }
        .hard-reset-btn:hover { background-color: #c82333 !important; }

        input[type="number"] { 
            padding: 8px; font-size: 16px; width: 100px; text-align: center; 
            border: 2px solid var(--input-border); border-radius: 4px; 
            background: var(--input-bg); color: var(--input-text);
        }
        .log-area { height: 120px; overflow-y: auto; background: #222; color: #0f0; padding: 8px; margin-top: 15px; font-family: monospace; border-radius: 5px; font-size: 11px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes glow { from { box-shadow: 0 0 5px #ffc107; } to { box-shadow: 0 0 20px #ff5722; } }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }

        @media (max-width: 768px) {
            .betting-area { grid-template-columns: repeat(2, 1fr); }
            .store-grid { grid-template-columns: repeat(2, 1fr); }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .info-panel { flex-direction: column; align-items: flex-start; }
            .weather-info { width: 100%; text-align: right; border-top: 1px solid var(--border-card); padding-top: 5px; margin-top: 5px; }
            .bet-row button { padding: 8px 6px; font-size: 12px; min-width: 45px; }
        }

        #dev-trigger-btn { margin-top: 20px; background: #333; color: #555; font-size: 10px; padding: 5px; float: right; }
        #dev-panel { display: none; background: #2c3e50; color: white; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .dev-active-border { border: 2px dashed #e74c3c !important; }
    </style>
</head>
<body>

<div class="container">
    <button id="theme-toggle-btn" onclick="toggleTheme()">ğŸŒ“ åˆ‡æ›æ¨¡å¼</button>
    <h1>ğŸ å‹•ç‰©å¤§è³½è·‘ - ä¸€ç„¡æ‰€æœ‰æˆ–è´ä¸‹æ‰€æœ‰ ğŸ†</h1>
    
    <div id="bonus-banner">ğŸ‰ ä¸»å§”åŠ ç¢¼ è¶…ç´šåŠ å€ï¼æœ¬å ´ç²å‹çé‡‘ x2 ğŸ‰</div>

    <div class="info-panel">
        <div class="funds-group">
            <div>ğŸ’° è³‡é‡‘: $<span id="funds">1000</span></div>
            <div id="relief-status" class="relief-info" style="display:none;">
                ğŸš‘ è²§çª®æ•‘æ¿Ÿ: <span id="timer-display"></span> (å·²é ˜ <span id="accumulated-display">$0</span>/1000)
            </div>
        </div>
        <div class="weather-info" id="weather-display">â˜€ï¸ å¤©æ°£: è¼‰å…¥ä¸­...</div>
    </div>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="switchTab('game')">ğŸ® æ¯”è³½å¤§å»³</button>
        <button class="nav-btn" onclick="switchTab('store')">ğŸ›’ é“å…·å•†åº—</button>
        <button class="nav-btn" onclick="switchTab('stats')">ğŸ“Š æ•¸æ“šçµ±è¨ˆ</button>
        <button class="nav-btn" onclick="switchTab('achieve')">ğŸ† æˆå°±åˆ—è¡¨</button>
    </div>

    <div id="tab-game" class="tab-content active">
        <h3>1. é¸æ“‡å ´åœ°</h3>
        <div class="venue-selection" id="venue-list"></div>

        <h3>2. é¸æ“‡é¸æ‰‹ (èˆ‡ä½¿ç”¨é“å…·)</h3>
        <div style="margin-bottom: 10px; font-size: 14px; color: var(--text-muted);">
            ç•¶å‰ä½¿ç”¨é“å…·: <span id="active-item-display" style="color: #007bff; font-weight: bold;">ç„¡</span>
        </div>
        <div class="betting-area" id="betting-area"></div>

        <div class="controls">
            <div class="bet-input-group">
                <button class="btn-minus" onclick="adjustBet(-50000)">-50k</button>
                <button class="btn-minus" onclick="adjustBet(-10000)">-10k</button>
                <button class="btn-minus" onclick="adjustBet(-1000)">-1k</button>
                <button class="btn-minus" onclick="adjustBet(-500)">-500</button>
                <button class="btn-minus" onclick="adjustBet(-100)">-100</button>
            </div>
            <div class="bet-input-group">
                <button class="btn-reset" onclick="resetBet()">é‡ç½®</button>
                <input type="number" id="bet-amount" placeholder="è³­é‡‘" min="100" step="100" value="100" readonly>
                <button class="btn-allin" onclick="setAllIn()">ALL IN</button>
            </div>
            <div class="bet-input-group">
                <button class="btn-plus" onclick="adjustBet(100)">+100</button>
                <button class="btn-plus" onclick="adjustBet(500)">+500</button>
                <button class="btn-plus" onclick="adjustBet(1000)">+1k</button>
                <button class="btn-plus-lg" onclick="adjustBet(10000)">+10k</button>
                <button class="btn-plus-lg" onclick="adjustBet(50000)">+50k</button>
            </div>
            <span id="min-bet-display" style="font-size:12px; color:var(--text-muted); display:block; margin-top:5px;">æœ€ä½ä¸‹æ³¨: $100</span>
            <br>
            <button id="start-btn" class="start-btn" onclick="startGame()">ğŸ é–‹å§‹æ¯”è³½</button>
            <button id="instant-end-btn" class="instant-end-btn" onclick="instantSettle()">âš¡ ç«‹å³çµç®—</button>
        </div>

        <div class="track-area" id="track-area"></div>
        <div class="log-area" id="game-log"></div>
    </div>

    <div id="tab-store" class="tab-content">
        <div style="margin-bottom:10px; font-size:14px; color:var(--text-muted);">æ¯ç¨®é“å…·æœ€å¤šæŒæœ‰ 5 å€‹ã€‚</div>
        <div class="store-grid" id="store-list"></div>
    </div>

    <div id="tab-stats" class="tab-content">
        <div class="stats-grid" id="stats-overview"></div>
        <h3>ğŸŸï¸ å ´åœ°æœ€é«˜ä¸‹æ³¨ç´€éŒ„</h3>
        <div id="venue-stats-list" class="list-group" style="margin-bottom:20px;"></div>
        <h3>ğŸ‡ å‹•ç‰©ä¸‹æ³¨æ¬¡æ•¸çµ±è¨ˆ</h3>
        <div id="animal-stats-list" class="list-group"></div>

        <div class="danger-zone">
            <div style="color:#dc3545; font-weight:bold; margin-bottom:10px;">âš ï¸ å±éšªå€åŸŸ</div>
            <button class="hard-reset-btn" onclick="hardResetGame()">ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰éŠæˆ²è³‡æ–™</button>
            <div style="font-size:12px; color:var(--text-muted); margin-top:5px;">é€™å°‡åˆªé™¤è³‡é‡‘ã€æˆå°±èˆ‡è³¼è²·ç´€éŒ„</div>
        </div>
    </div>

    <div id="tab-achieve" class="tab-content">
        <div class="achieve-list" id="achieve-list"></div>
    </div>

    <button id="dev-trigger-btn" onclick="toggleDevPanel()">ğŸ› ï¸ é–‹ç™¼è€…é¸é …</button>
    <div id="dev-panel">
        <h4>ğŸ”§ é–‹ç™¼è€…æ§åˆ¶å°</h4>
        <button onclick="devAddFunds()" style="background:#e67e22;">ğŸ’° +1000 è³‡é‡‘</button>
        <button onclick="devResetMatch()" style="background:#c0392b;">ğŸ”„ é‡ç½®æ¯”è³½</button>
        <button onclick="exitDevMode()" style="background:#7f8c8d;">ğŸšª é€€å‡º</button>
    </div>
</div>

<script>
// --- 0. ä¸»é¡Œæ§åˆ¶ ---
function loadTheme() {
    const savedTheme = localStorage.getItem('raceGameTheme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-toggle-btn').innerText = "â˜€ï¸ æ˜äº®æ¨¡å¼";
    }
}

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('raceGameTheme', isDark ? 'dark' : 'light');
    document.getElementById('theme-toggle-btn').innerText = isDark ? "â˜€ï¸ æ˜äº®æ¨¡å¼" : "ğŸŒ“ æ·±è‰²æ¨¡å¼";
}

// --- 1. éŠæˆ²è³‡æ–™è¨­å®š ---
const ANIMAL_DATA = [
    { name: "é–ƒé›»å…”", icon: "ğŸ‡", fav: "æ™´å¤©" },
    { name: "æš´é¢¨é¦¬", icon: "ğŸ", fav: "æ™´å¤©" },
    { name: "æ…¢åé¾œ", icon: "ğŸ¢", fav: "é›¨å¤©" },
    { name: "è¡é‹’è±¹", icon: "ğŸ†", fav: "å¤§é¢¨" },
    { name: "æ‡¶æƒ°è²“", icon: "ğŸˆ", fav: "ç†±æµª" },
    { name: "æš´åŠ›ç†Š", icon: "ğŸ»", fav: "é›¨å¤©" },
    { name: "éˆæ´»çŒ´", icon: "ğŸ’", fav: "ç†±æµª" },
    { name: "å¦å…‹è±¬", icon: "ğŸ–", fav: "å¤§é¢¨" }
];

const VENUES = [
    { name: "æ–°æ‰‹è‰åœ°", length: 2000, minFunds: 0, eventProb: 0.005, desc: "ç„¡å…¥å ´é–€æª»" },
    { name: "é€²éšæ³¥åœ°", length: 4000, minFunds: 2000, eventProb: 0.010, desc: "$2000+" },
    { name: "å°ˆæ¥­æ²™åœ°", length: 6000, minFunds: 10000, eventProb: 0.015, desc: "$10000+" },
    { name: "å¤§å¸«å±±è·¯", length: 8000, minFunds: 50000, eventProb: 0.020, desc: "$50000+" },
    { name: "å‚³å¥‡æµ·å²¸", length: 12000, minFunds: 200000, eventProb: 0.025, desc: "$200000+" }
];

const WEATHERS = [
    { name: "æ™´å¤©", effect: "normal" }, { name: "é›¨å¤©", effect: "slippery" }, 
    { name: "å¤§é¢¨", effect: "resistance" }, { name: "ç†±æµª", effect: "tired" }
];

const EVENTS = [
    { text: "åƒè‰ ğŸŒ¿", type: "stop", val: 1500 }, { text: "è¡åˆº ğŸ’¨", type: "speed", val: 1.5 },
    { text: "çµ†å€’ ğŸª¨", type: "stop", val: 1200 }, { text: "æ»‘å€’ ğŸŒ", type: "progress", val: 50 },
    { text: "é€†é¢¨ ğŸŒ¬ï¸", type: "speed", val: 0.7 }, { text: "é‹é¬† ğŸ‘Ÿ", type: "stop", val: 1000 },
    { text: "æ¨æ“  ğŸ˜¤", type: "stop", val: 800 }, { text: "å–æ°´ ğŸ¥¤", type: "speed", val: 1.8 },
    { text: "æ­¡å‘¼ ğŸ‰", type: "speed", val: 1.3 }, { text: "è…¹ç—› ğŸš½", type: "stop", val: 2500 },
    { text: "è¿·è·¯ ğŸ—ºï¸", type: "progress", val: -50 }, { text: "æŠ½ç­‹ ğŸ˜«", type: "speed", val: 0.4 },
    { text: "å™´å°„èƒŒåŒ… ğŸš€", type: "speed", val: 3.0, rare: true }, { text: "è¨ˆç¨‹è»Š ğŸš•", type: "speed", val: 2.5, rare: true },
    { text: "æ·å¾‘ ğŸ•³ï¸", type: "progress", val: 300, rare: true }, { text: "UFOæ¨ ğŸ›¸", type: "speed", val: 3.5, rare: true },
    { text: "é™·é˜± ğŸ•³ï¸", type: "stop", val: 4000, rare: true }, { text: "ç‹‚æš´ âš¡", type: "speed", val: 2.2, rare: true }
];

const MAX_ITEM_COUNT = 5;
const STORE_ITEMS = [
    { id: 'insurance', name: 'ğŸ›¡ï¸ ä¿éšªè­‰', desc: 'è¼¸äº†é€€é‚„ 50% æœ¬é‡‘', price: 150, type: 'loss' },
    { id: 'win_x12', name: 'ğŸ¥¤ èƒ½é‡æ°´', desc: 'ç²å‹çé‡‘ x1.2', price: 200, type: 'win' },
    { id: 'win_x15', name: 'ğŸ’‰ èˆˆå¥®åŠ‘', desc: 'ç²å‹çé‡‘ x1.5', price: 500, type: 'win' },
    { id: 'win_x18', name: 'ğŸ’Š ç¦è—¥', desc: 'ç²å‹çé‡‘ x1.8', price: 1000, type: 'win' },
    { id: 'place_bet', name: 'ğŸ¥‰ å®‰æ…°ç', desc: 'ç¬¬2æˆ–3åç²å¾—ä¸€åŠè³ ç‡çé‡‘', price: 300, type: 'loss' }
];

const ACHIEVEMENTS = [
    { id: 'win_5', title: 'åˆè©¦å•¼è²', desc: 'è´å¾— 5 å ´æ¯”è³½', condition: (s) => s.wins >= 5 },
    { id: 'win_50', title: 'è³­ç¥å†ä¸–', desc: 'è´å¾— 50 å ´æ¯”è³½', condition: (s) => s.wins >= 50 },
    { id: 'loss_10', title: 'ç¹³å­¸è²»', desc: 'è¼¸æ‰ 10 å ´æ¯”è³½', condition: (s) => s.losses >= 10 },
    { id: 'streak_3', title: 'é€£æˆ°é€£å‹', desc: 'é€£çºŒè´ 3 å ´', condition: (s) => s.winStreak >= 3 },
    { id: 'earn_10k', title: 'ç¬¬ä¸€æ¡¶é‡‘', desc: 'ç¸½çé‡‘è¶…é $10,000', condition: (s) => s.totalEarned >= 10000 },
    { id: 'relief_5', title: 'ä¹è¨å¤§å¸«', desc: 'é ˜å–æ•‘æ¿Ÿé‡‘ 5 æ¬¡', condition: (s) => s.totalRelief >= 5 },
    { id: 'high_roller', title: 'è±ªè³­å®¢', desc: 'å–®å ´ä¸‹æ³¨è¶…é $3000', condition: (s) => s.highestBet >= 3000 },
    { id: 'item_master', title: 'é“å…·å¤§å¸«', desc: 'ç´¯è¨ˆä½¿ç”¨ 20 æ¬¡é“å…·', condition: (s) => s.itemsUsed >= 20 },
    { id: 'impatient', title: 'æ€¥æ€§å­', desc: 'ä½¿ç”¨ç«‹å³çµç®— 10 æ¬¡', condition: (s) => s.instantSettles >= 10 },
    { id: 'insurance_fraud', title: 'ä¿éšªè©é ˜', desc: 'ç²å¾—ä¿éšªç†è³  5 æ¬¡', condition: (s) => s.insuranceClaims >= 5 },
    { id: 'hoarder', title: 'å›¤è²¨é”äºº', desc: 'æŒæœ‰ 5 å€‹ç›¸åŒçš„é“å…·', condition: (s) => s.totalItemsBought >= 50 },
    { id: 'venue_0', title: 'æ–°æ‰‹ä¸Šè·¯', desc: 'åœ¨æ–°æ‰‹è‰åœ°ç²å‹', condition: (s) => s.venueWins[0] >= 1 },
    { id: 'venue_1', title: 'æ³¥åœ°æ‘”è§’', desc: 'åœ¨é€²éšæ³¥åœ°ç²å‹', condition: (s) => s.venueWins[1] >= 1 },
    { id: 'venue_2', title: 'æ²™å ´è€å°‡', desc: 'åœ¨å°ˆæ¥­æ²™åœ°ç²å‹', condition: (s) => s.venueWins[2] >= 1 },
    { id: 'venue_3', title: 'å±±é“ä¹‹ç‹', desc: 'åœ¨å¤§å¸«å±±è·¯ç²å‹', condition: (s) => s.venueWins[3] >= 1 },
    { id: 'millionaire', title: 'å„„è¬å¯Œç¿', desc: 'æŒæœ‰è³‡é‡‘çªç ´ $50,000', condition: (s) => s.maxFundsReached >= 50000 },
    { id: 'shopaholic', title: 'è³¼ç‰©ç‹‚', desc: 'ç´¯è¨ˆè³¼è²· 50 å€‹é“å…·', condition: (s) => s.totalItemsBought >= 50 },
    { id: 'silver_medal', title: 'æ°¸é çš„äºè»', desc: 'ç²å¾—ç¬¬äºŒå 5 æ¬¡', condition: (s) => s.secondPlaceCount >= 5 },
    { id: 'penny_pincher', title: 'å°è³‡å¤§å‹', desc: 'ç”¨å ´åœ°æœ€ä½ä¸‹æ³¨é¡ç²å‹', condition: (s) => s.minBetWins >= 1 },
    { id: 'legendary_conqueror', title: 'å‚³å¥‡å¾æœè€…', desc: 'åœ¨å‚³å¥‡æµ·å²¸ç²å¾—å‹åˆ©', condition: (s) => s.legendaryWins >= 1 },
    { id: 'turtle_rain', title: 'æ°´é™¸å…©æ£²', desc: 'æ…¢åé¾œåœ¨é›¨å¤©ç²å‹', condition: (s) => s.turtleRainWins >= 1 },
    { id: 'cheetah_wind', title: 'é¢¨ä¹‹å­', desc: 'è¡é‹’è±¹åœ¨å¤§é¢¨å¤©ç²å‹', condition: (s) => s.cheetahWindWins >= 1 },
    { id: 'bonus_friend', title: 'ä¸»å§”çš„å¥½æœ‹å‹', desc: 'åœ¨ä¸»å§”åŠ ç¢¼å±€ç²å‹', condition: (s) => s.bonusWins >= 1 },
    { id: 'miracle_run', title: 'å¥‡è¹Ÿé™è‡¨', desc: 'æŠ¼æ³¨è³ ç‡ 9.0 ä»¥ä¸Šç²å‹', condition: (s) => s.miracleWins >= 1 },
    { id: 'bad_beat', title: 'è·Œç ´çœ¼é¡', desc: 'æŠ¼æ³¨è³ ç‡ 1.5 ä»¥ä¸‹å»è¼¸äº†', condition: (s) => s.upsetLosses >= 1 }
];

// --- 2. å…¨åŸŸè®Šæ•¸ ---
let funds = 1000;
let currentVenueIndex = 0;
let currentMinBet = 100;
let currentWeather = null;
let animals = [];
let selectedAnimalIndex = -1;
let isRacing = false;
let raceInterval = null;

// æ•‘æ¿Ÿé‡‘ç›¸é—œ
let reliefNextTime = null; 
let reliefAccumulated = 0; 
const RELIEF_INTERVAL = 10 * 60 * 1000; 
const RELIEF_MAX_ACCUMULATION = 1000; 
const RELIEF_STOP_THRESHOLD = 1000; 

let isDevMode = false;
let todayMatchCount = 0;
let isBonusRound = false; 

let playerInventory = {}; 
let activeItem = null; 
let playerStats = {
    wins: 0, losses: 0, winStreak: 0, lossStreak: 0, 
    totalEarned: 0, totalRelief: 0, unlockedAchievements: [],
    highestBet: 0, itemsUsed: 0, instantSettles: 0, insuranceClaims: 0,
    safeBetWins: 0, longShotWins: 0,
    totalBetAmount: 0, 
    venueMaxBets: [0, 0, 0, 0, 0], 
    itemWins: 0,
    bonusWins: 0,
    totalReliefAmount: 0,
    animalBetCounts: [0, 0, 0, 0, 0, 0, 0, 0],
    venueWins: [0, 0, 0, 0, 0],
    totalItemsBought: 0,
    maxFundsReached: 0,
    secondPlaceCount: 0,
    minBetWins: 0,
    legendaryWins: 0, turtleRainWins: 0, cheetahWindWins: 0, miracleWins: 0, upsetLosses: 0
};

// --- 3. åˆå§‹åŒ– ---
window.onload = function() {
    loadTheme();
    loadGameData();
    checkDailyReset(); 
    renderStore();
    renderAchievements();
    renderStats();

    let hasSavedMatch = loadMatchState();
    if (!hasSavedMatch) {
        selectVenue(0); 
        resetMatch(true);
    } else {
        log("æ¢å¾©æœªå®Œæˆçš„è³½äº‹ã€‚");
        requestAnimationFrame(() => updateRankings(true));
    }
    // æ¯ç§’æª¢æŸ¥ä¸€æ¬¡æ•‘æ¿Ÿé‡‘
    setInterval(checkReliefSystem, 1000); 
};

// --- 4. æ ¸å¿ƒé¡åˆ¥ ---
class Animal {
    constructor(id, data, venueLength, weather, savedOdds = null) {
        this.id = id;
        this.name = data.name;
        this.icon = data.icon;
        this.favWeather = data.fav;
        
        // å¦‚æœæœ‰å­˜æª”ï¼Œä½¿ç”¨å­˜æª”è³ ç‡ï¼›å¦å‰‡åœ¨ resetMatch æ™‚ç”± generateDistinctOdds ç”Ÿæˆå¾Œå‚³å…¥
        this.odds = savedOdds ? savedOdds : 1.1; 
        this.recalcSpeed(venueLength, weather);
        
        this.position = 0; 
        this.status = ""; 
        this.finished = false;
        this.finishOrder = 0;
        this.speedBoostTimer = null;
    }

    recalcSpeed(venueLength, weather) {
        const targetFrames = 600; 
        const avgSpeed = venueLength / targetFrames;
        const minOdds = 1.1; const maxOdds = 10.0;
        let oddsRatio = (this.odds - minOdds) / (maxOdds - minOdds);
        let speedFactor = 1.25 - (oddsRatio * 0.5); 
        speedFactor += (Math.random() * 0.05 - 0.025);
        this.baseSpeed = avgSpeed * speedFactor;
        this.isFavWeather = (weather.name === this.favWeather);
        if (this.isFavWeather) this.baseSpeed *= 1.05; 
        this.currentSpeed = this.baseSpeed;
    }

    update(venueLength, weather, eventProb) {
        if (this.finished) return;

        let weatherMod = 1;
        if (weather.name === "é›¨å¤©" && Math.random() < 0.01) this.triggerEvent({text:"æ‰“æ»‘", type:"stop", val:500});
        if (weather.name === "å¤§é¢¨") weatherMod = 0.9;
        
        let actualProb = eventProb;
        if (this.isFavWeather) actualProb *= 1.15;

        if (Math.random() < actualProb) {
            let evt = EVENTS[Math.floor(Math.random() * EVENTS.length)];
            if (evt.rare && Math.random() > 0.2) return; 
            if (this.isFavWeather) {
                let isBad = evt.type === 'stop' || evt.type === 'progress' && evt.val < 0 || evt.type === 'speed' && evt.val < 1;
                if (isBad && Math.random() < 0.5) evt = EVENTS[Math.floor(Math.random() * EVENTS.length)];
            }
            this.triggerEvent(evt);
        }

        this.position += this.currentSpeed * weatherMod;
        
        if (this.position >= venueLength) {
            this.position = venueLength;
            this.finished = true;
        }
    }

    triggerEvent(evt) {
        if (activeItem) return; 
        log(`${this.name} ${evt.text}`);
        this.status = evt.text.split(" ")[0];
        setTimeout(() => { this.status = ""; }, 1000);

        if (evt.type === "speed") {
            if(this.speedBoostTimer) clearTimeout(this.speedBoostTimer);
            this.currentSpeed = this.baseSpeed * evt.val;
            this.speedBoostTimer = setTimeout(() => { 
                this.currentSpeed = this.baseSpeed; 
                this.speedBoostTimer = null;
            }, 2000);
        } else if (evt.type === "stop") {
            this.currentSpeed = 0;
            setTimeout(() => { this.currentSpeed = this.baseSpeed; }, evt.val);
        } else if (evt.type === "progress") {
            this.position += evt.val;
        }
    }
}

// --- 5. éŠæˆ²æµç¨‹ ---

// --- éšæ¢¯å¼è³ ç‡ç”Ÿæˆç®—æ³• ---
function generateDistinctOdds() {
    // 1. å®šç¾©éšæ¢¯åŸºåº• (ç¸½å’Œ ~36)
    let baseOdds = [1.2, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0];
    
    // 2. åŠ ä¸Šéš¨æ©Ÿæµ®å‹• (0.0 ~ 0.5)
    let odds = baseOdds.map(o => o + Math.random() * 0.5);
    
    // 3. ç¢ºä¿ç¸½å’Œ <= 40
    let sum = odds.reduce((a, b) => a + b, 0);
    if (sum > 40) {
        // å¦‚æœè¶…éï¼Œç­‰æ¯”ä¾‹ç¸®å° (ä¿ç•™æœ€å° 1.1)
        let scale = 38 / sum; 
        odds = odds.map(o => Math.max(1.1, o * scale));
    }
    
    // 4. æ ¼å¼åŒ–ç‚ºå°æ•¸é» 2 ä½
    odds = odds.map(o => parseFloat(o.toFixed(2)));
    
    // 5. æ´—ç‰Œ (è®“èª°æ˜¯ç†±é–€ä¸å›ºå®š)
    return odds.sort(() => Math.random() - 0.5);
}

function startGame() {
    let amount = parseInt(document.getElementById('bet-amount').value);
    
    if (selectedAnimalIndex === -1) { alert("è«‹å…ˆé¸æ“‡ä¸€éš»å‹•ç‰©ï¼"); return; }
    if (isNaN(amount) || amount < currentMinBet) { alert(`æœ€ä½ä¸‹æ³¨ $${currentMinBet}`); return; }
    if (amount % 100 !== 0) { alert("ä¸‹æ³¨é‡‘é¡éœ€ç‚º 100 å€æ•¸"); return; }
    if (amount > funds) { alert("è³‡é‡‘ä¸è¶³"); return; }

    if (activeItem) {
        if (!playerInventory[activeItem] || playerInventory[activeItem] <= 0) {
            alert("é“å…·åº«å­˜ä¸è¶³ï¼"); return;
        }
        playerInventory[activeItem]--;
        playerStats.itemsUsed = (playerStats.itemsUsed || 0) + 1; 
        renderStore(); 
        log(`ä½¿ç”¨äº†é“å…·: ${STORE_ITEMS.find(i=>i.id===activeItem).name}`);
    }

    funds -= amount;
    todayMatchCount++;
    
    if (amount > (playerStats.highestBet || 0)) playerStats.highestBet = amount;
    playerStats.totalBetAmount += amount;
    playerStats.animalBetCounts[selectedAnimalIndex]++;
    if (amount > playerStats.venueMaxBets[currentVenueIndex]) playerStats.venueMaxBets[currentVenueIndex] = amount;

    updateFundsDisplay();
    isRacing = true;
    setUIState('racing');

    let venue = VENUES[currentVenueIndex];
    let title = `--- ä»Šæ—¥ç¬¬ ${todayMatchCount} å ´æ¯”è³½ ---`;
    if (isBonusRound) title += " [ä¸»å§”åŠ ç¢¼!]";
    log(title);
    log(`å ´åœ°ï¼š${venue.name} | ä¸‹æ³¨: $${amount} | é“å…·: ${activeItem ? STORE_ITEMS.find(i=>i.id===activeItem).name : 'ç„¡'}`);

    let finishedCount = 0;
    
    raceInterval = setInterval(() => {
        let allFinished = true;
        let playerFinished = false;
        
        animals.forEach(ani => {
            ani.update(venue.length, currentWeather, venue.eventProb);
            
            let pct = (ani.position / venue.length) * 100;
            if(pct > 100) pct = 100;
            document.getElementById(`bar-${ani.id}`).style.width = `${pct}%`;
            document.getElementById(`status-${ani.id}`).innerText = ani.status;

            if (!ani.finished) {
                allFinished = false;
            } else if (ani.finishOrder === 0) {
                finishedCount++;
                ani.finishOrder = finishedCount;
                log(`ç¬¬ ${finishedCount} å: ${ani.name}`);
            }

            if (ani.id === selectedAnimalIndex && ani.finished) {
                playerFinished = true;
            }
        });

        updateRankings();

        if (playerFinished && !allFinished) {
            document.getElementById('instant-end-btn').style.display = 'block';
        }

        if (allFinished) {
            endGame(amount);
        }

    }, 50);
}

function updateRankings(forceReset = false) {
    let sortedAnimals = [...animals].sort((a, b) => {
        if (a.finished && b.finished) return a.finishOrder - b.finishOrder;
        if (a.finished) return -1;
        if (b.finished) return 1;
        return b.position - a.position;
    });

    const LANE_HEIGHT = 45; 
    sortedAnimals.forEach((ani, rankIndex) => {
        let laneEl = document.getElementById(`lane-${ani.id}`);
        if(laneEl) {
            laneEl.style.top = `${rankIndex * LANE_HEIGHT + 5}px`; 
            let rankIndicator = laneEl.querySelector('.lane-rank-indicator');
            rankIndicator.style.display = 'block';
            rankIndicator.innerText = `#${rankIndex + 1}`;
            rankIndicator.style.color = rankIndex === 0 ? '#ffd700' : (rankIndex === 1 ? '#c0c0c0' : (rankIndex === 2 ? '#cd7f32' : (document.body.classList.contains('dark-mode') ? '#fff' : '#000')));
        }
    });
}

function instantSettle() {
    if (!isRacing) return;
    playerStats.instantSettles = (playerStats.instantSettles || 0) + 1; 
    clearInterval(raceInterval);
    document.getElementById('instant-end-btn').style.display = 'none';
    
    let venueLen = VENUES[currentVenueIndex].length;
    let finishedCount = animals.filter(a => a.finishOrder > 0).length;

    while (finishedCount < 8) {
        animals.forEach(ani => {
            if (!ani.finished) {
                ani.position += ani.baseSpeed * 2; 
                if (ani.position >= venueLen) {
                    ani.position = venueLen;
                    ani.finished = true;
                    finishedCount++;
                    ani.finishOrder = finishedCount;
                    log(`(çµç®—) ç¬¬ ${finishedCount} å: ${ani.name}`);
                }
            }
        });
    }
    
    animals.forEach(ani => {
        document.getElementById(`bar-${ani.id}`).style.width = '100%';
        document.getElementById(`status-${ani.id}`).innerText = "å®Œè³½";
    });

    updateRankings();
    let amount = parseInt(document.getElementById('bet-amount').value);
    endGame(amount);
}

function endGame(betAmount) {
    clearInterval(raceInterval);
    isRacing = false;
    setUIState('idle');
    
    let winner = animals.find(a => a.finishOrder === 1);
    let playerChoice = animals[selectedAnimalIndex];
    let winAmount = 0;
    let resultMsg = "";

    log(`ğŸ† å† è»ï¼š${winner.name}`);

    if (playerChoice.finishOrder === 2) {
        playerStats.secondPlaceCount = (playerStats.secondPlaceCount || 0) + 1;
    }

    if (playerChoice.id === winner.id) {
        let multiplier = 1;
        if (activeItem === 'win_x12') multiplier = 1.2;
        if (activeItem === 'win_x15') multiplier = 1.5;
        if (activeItem === 'win_x18') multiplier = 1.8;
        
        let rawWin = betAmount * playerChoice.odds * multiplier;
        if (isBonusRound) rawWin *= 2; 

        winAmount = Math.ceil(rawWin);
        funds += winAmount;
        
        resultMsg = `æ­å–œç²å‹ï¼ç²å¾— $${winAmount}`;
        if (isBonusRound) resultMsg += ` (ä¸»å§”åŠ ç¢¼ x2!)`;
        if (multiplier > 1) resultMsg += ` (é“å…·åŠ æˆ)`;
        
        playerStats.wins++;
        playerStats.winStreak++;
        playerStats.lossStreak = 0;
        playerStats.totalEarned += winAmount;
        
        if (activeItem) playerStats.itemWins++;
        if (isBonusRound) playerStats.bonusWins++;
        if (playerChoice.odds < 2.0) playerStats.safeBetWins = (playerStats.safeBetWins || 0) + 1;
        if (playerChoice.odds > 5.0) playerStats.longShotWins = (playerStats.longShotWins || 0) + 1;

        playerStats.venueWins[currentVenueIndex] = (playerStats.venueWins[currentVenueIndex] || 0) + 1;
        if (currentVenueIndex === 4) playerStats.legendaryWins++; 
        if (betAmount === currentMinBet) playerStats.minBetWins = (playerStats.minBetWins || 0) + 1;
        
        if (playerChoice.name === "æ…¢åé¾œ" && currentWeather.name === "é›¨å¤©") playerStats.turtleRainWins++;
        if (playerChoice.name === "è¡é‹’è±¹" && currentWeather.name === "å¤§é¢¨") playerStats.cheetahWindWins++;
        if (playerChoice.odds >= 9.0) playerStats.miracleWins++;

    } else {
        if (activeItem === 'insurance') {
            winAmount = Math.ceil(betAmount * 0.5);
            funds += winAmount;
            resultMsg = `è¼¸äº†ï¼Œä½†ä¿éšªé€€é‚„ $${winAmount}`;
            playerStats.insuranceClaims = (playerStats.insuranceClaims || 0) + 1;
        } else if (activeItem === 'place_bet' && playerChoice.finishOrder <= 3) {
            let rawWin = betAmount * playerChoice.odds * 0.5;
            winAmount = Math.ceil(rawWin);
            funds += winAmount;
            resultMsg = `ç²å¾—ç¬¬ ${playerChoice.finishOrder} åï¼Œå®‰æ…°ç $${winAmount}`;
        } else {
            resultMsg = `å¯æƒœï¼ç²å¾—ç¬¬ ${playerChoice.finishOrder} åã€‚`;
        }

        playerStats.losses++;
        playerStats.lossStreak++;
        playerStats.winStreak = 0;
        if (playerChoice.odds <= 1.5) playerStats.upsetLosses++;
    }

    if (funds > playerStats.maxFundsReached) playerStats.maxFundsReached = funds;

    log(resultMsg);
    alert(resultMsg);

    activeItem = null; 
    document.getElementById('active-item-display').innerText = "ç„¡";
    renderStore(); 

    checkAchievements();
    renderStats(); 
    updateFundsDisplay();
    clearMatchState();
    
    setTimeout(() => { resetMatch(true); }, 3000);
}

// --- 6. çµ±è¨ˆèˆ‡å•†åº— ---

function renderStats() {
    let totalRaces = playerStats.wins + playerStats.losses;
    let winRate = totalRaces > 0 ? ((playerStats.wins / totalRaces) * 100).toFixed(1) + '%' : '0%';

    document.getElementById('stats-overview').innerHTML = `
        <div class="stat-card"><div class="stat-value">${totalRaces}</div><div class="stat-label">ç´¯ç©å ´æ¬¡</div></div>
        <div class="stat-card"><div class="stat-value">$${playerStats.totalBetAmount.toLocaleString()}</div><div class="stat-label">ç´¯ç©ä¸‹æ³¨</div></div>
        <div class="stat-card"><div class="stat-value">$${playerStats.totalEarned.toLocaleString()}</div><div class="stat-label">ç´¯ç©çé‡‘</div></div>
        <div class="stat-card"><div class="stat-value">${winRate}</div><div class="stat-label">ç¸½å‹ç‡</div></div>
        <div class="stat-card"><div class="stat-value">${playerStats.itemWins}</div><div class="stat-label">é“å…·ç²å‹å ´</div></div>
        <div class="stat-card"><div class="stat-value">${playerStats.bonusWins}</div><div class="stat-label">åŠ ç¢¼ç²å‹å ´</div></div>
        <div class="stat-card"><div class="stat-value">$${playerStats.totalReliefAmount.toLocaleString()}</div><div class="stat-label">é ˜å–æ•‘æ¿Ÿé‡‘</div></div>
    `;

    let venueHtml = "";
    VENUES.forEach((v, i) => {
        let maxBet = playerStats.venueMaxBets[i] || 0;
        venueHtml += `
            <div class="list-item">
                <span>${v.name}</span>
                <span style="font-weight:bold;">$${maxBet.toLocaleString()}</span>
            </div>
        `;
    });
    document.getElementById('venue-stats-list').innerHTML = venueHtml;

    let animalHtml = "";
    let maxCount = Math.max(...playerStats.animalBetCounts, 1); 
    ANIMAL_DATA.forEach((ani, i) => {
        let count = playerStats.animalBetCounts[i] || 0;
        let barWidth = (count / maxCount) * 100;
        animalHtml += `
            <div class="list-item">
                <div style="display:flex; align-items:center; width: 120px;">
                    <span style="font-size:18px; margin-right:5px;">${ani.icon}</span> ${ani.name}
                </div>
                <div style="display:flex; align-items:center; flex:1;">
                    <div class="bar-container">
                        <div class="bar-fill" style="width:${barWidth}%"></div>
                    </div>
                    <span style="margin-left:10px; font-weight:bold;">${count}æ¬¡</span>
                </div>
            </div>
        `;
    });
    document.getElementById('animal-stats-list').innerHTML = animalHtml;
}

function buyItem(itemId) {
    if (isRacing) return;
    let item = STORE_ITEMS.find(i => i.id === itemId);
    let currentCount = playerInventory[itemId] || 0;

    if (currentCount >= MAX_ITEM_COUNT) {
        alert("æŒæœ‰å·²é”ä¸Šé™ (5å€‹)ï¼ç„¡æ³•å†è³¼è²·ã€‚");
        return;
    }

    if (funds < item.price) {
        alert("è³‡é‡‘ä¸è¶³ï¼");
        return;
    }

    if (funds - item.price < 100) {
        if (!confirm(`âš ï¸ è­¦å‘Šï¼šè³¼è²·æ­¤é“å…·å¾Œï¼Œæ‚¨çš„è³‡é‡‘å°‡ä½æ–¼ $100ã€‚\né€™å¯èƒ½æœƒä½¿æ‚¨é™·å…¥ç„¡æ³•ä¸‹æ³¨çš„é¢¨éšªï¼Œç¢ºå®šè¦è³¼è²·å—ï¼Ÿ`)) {
            return;
        }
    }

    funds -= item.price;
    playerInventory[itemId] = currentCount + 1;
    playerStats.totalItemsBought = (playerStats.totalItemsBought || 0) + 1; 
    
    updateFundsDisplay();
    renderStore();
    log(`è³¼è²·äº† ${item.name}`);
}

function selectItem(itemId) {
    if (isRacing) return;
    if (!playerInventory[itemId] || playerInventory[itemId] <= 0) return; 
    activeItem = (activeItem === itemId) ? null : itemId;
    document.getElementById('active-item-display').innerText = activeItem ? STORE_ITEMS.find(i=>i.id===activeItem).name : "ç„¡";
    renderStore();
}

function renderStore() {
    let html = "";
    STORE_ITEMS.forEach(item => {
        let count = playerInventory[item.id] || 0;
        let isSelected = activeItem === item.id;
        let countDisplay = `<div class="item-count">${count}/${MAX_ITEM_COUNT}</div>`;
        html += `<div class="item-card ${count > 0 ? 'owned' : ''} ${isSelected ? 'selected' : ''}" onclick="selectItem('${item.id}')">${countDisplay}<div class="item-icon">${item.name.split(' ')[0]}</div><div class="item-name">${item.name.split(' ')[1]}</div><div class="item-desc">${item.desc}</div><div class="item-price">$${item.price}</div><button class="buy-btn" onclick="event.stopPropagation(); buyItem('${item.id}')">è³¼è²·</button></div>`;
    });
    document.getElementById('store-list').innerHTML = html;
}

// --- å…¶é¤˜è¼”åŠ© ---
function checkAchievements() {
    let newUnlock = false;
    ACHIEVEMENTS.forEach(ach => {
        if (!playerStats.unlockedAchievements.includes(ach.id)) {
            if (ach.condition(playerStats)) {
                playerStats.unlockedAchievements.push(ach.id);
                log(`ğŸ† è§£é–æˆå°±ï¼š${ach.title}`);
                alert(`ğŸ† è§£é–æˆå°±ï¼š${ach.title}\n${ach.desc}`);
                newUnlock = true;
            }
        }
    });
    if (newUnlock) renderAchievements();
}
function renderAchievements() {
    let html = "";
    ACHIEVEMENTS.forEach(ach => {
        let unlocked = playerStats.unlockedAchievements.includes(ach.id);
        html += `<div class="achieve-item ${unlocked ? 'unlocked' : ''}"><div class="achieve-icon">ğŸ†</div><div class="achieve-info"><div class="achieve-title">${ach.title} ${unlocked ? 'âœ…' : 'ğŸ”’'}</div><div class="achieve-desc">${ach.desc}</div></div></div>`;
    });
    document.getElementById('achieve-list').innerHTML = html;
}
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.add('active');
    event.target.classList.add('active');
}
function setUIState(state) {
    let disabled = (state === 'racing');
    document.getElementById('start-btn').disabled = disabled;
    document.querySelectorAll('.buy-btn').forEach(b => b.disabled = disabled);
    document.querySelectorAll('.venue-card').forEach(c => c.style.pointerEvents = disabled ? 'none' : 'auto');
    document.querySelectorAll('.bet-card').forEach(c => c.classList.toggle('disabled', disabled));
    // ç¦ç”¨æ‰€æœ‰åŠ æ¸›æŒ‰éˆ•
    document.querySelectorAll('.btn-minus, .btn-plus, .btn-plus-lg, .btn-reset, .btn-allin').forEach(b => b.disabled = disabled);
    
    if(!disabled) document.getElementById('instant-end-btn').style.display = 'none';
}

function resetMatch(isForceNew = false) {
    isBonusRound = Math.random() < 0.05;
    document.getElementById('bonus-banner').style.display = isBonusRound ? 'block' : 'none';
    currentWeather = WEATHERS[Math.floor(Math.random() * WEATHERS.length)];
    document.getElementById('weather-display').innerText = `${currentWeather.name === 'æ™´å¤©' ? 'â˜€ï¸' : currentWeather.name === 'é›¨å¤©' ? 'ğŸŒ§ï¸' : 'ğŸ’¨'} å¤©æ°£: ${currentWeather.name}`;
    animals = [];
    let bettingHTML = "";
    let trackHTML = "";
    let venueLen = VENUES[currentVenueIndex].length;
    
    // ç”Ÿæˆå¹³è¡¡å¾Œçš„è³ ç‡
    let distinctOdds = generateDistinctOdds();

    for(let i=0; i<8; i++) {
        let data = ANIMAL_DATA[i];
        let ani = new Animal(i, data, venueLen, currentWeather, distinctOdds[i]);
        animals.push(ani);
        let favInfo = ani.isFavWeather ? `<div class="fav-weather" style="color:red; font-weight:bold;">ğŸ”¥ å¤©æ°£å„ªå‹¢ï¼</div>` : `<div class="fav-weather">å–œå¥½: ${ani.favWeather}</div>`;
        bettingHTML += `<div class="bet-card" id="bet-${i}" onclick="handleAnimalClick(${i})"><div style="font-size:20px">${ani.icon} ${ani.name}</div>${favInfo}<div class="odds-text" id="odds-display-${i}">x${ani.odds}</div></div>`;
        trackHTML += `
            <div class="lane" id="lane-${i}" style="top: ${i * 45 + 5}px;">
                <div class="lane-rank-indicator">#${i+1}</div>
                <div class="lane-name">${ani.icon} ${ani.name}</div>
                <div class="progress-bar" id="bar-${i}"><div class="animal-icon">${ani.icon}</div></div>
                <div class="status-text" id="status-${i}"></div>
            </div>`;
    }
    document.getElementById('betting-area').innerHTML = bettingHTML;
    document.getElementById('track-area').innerHTML = trackHTML;
    selectedAnimalIndex = -1;
    setUIState('idle');
    saveMatchState();
}

function selectVenue(index) {
    if (isRacing) return;
    currentVenueIndex = index;
    let venueData = VENUES[index];
    currentMinBet = venueData.minFunds > 0 ? venueData.minFunds : 100;
    let input = document.getElementById('bet-amount');
    if(parseInt(input.value) < currentMinBet) input.value = currentMinBet;
    document.getElementById('min-bet-display').innerText = `æœ€ä½ä¸‹æ³¨: $${currentMinBet}`;
    renderVenues();
    if(animals.length > 0) { animals.forEach(ani => ani.recalcSpeed(venueData.length, currentWeather)); saveMatchState(); }
}
function renderVenues() {
    let html = "";
    VENUES.forEach((v, idx) => {
        let isLocked = funds < v.minFunds;
        let isActive = idx === currentVenueIndex;
        if (isActive && isLocked) { currentVenueIndex = 0; isActive = false; setTimeout(() => selectVenue(0), 0); return; }
        html += `<div class="venue-card ${isLocked ? 'locked' : ''} ${isActive ? 'active' : ''}" onclick="${isLocked ? '' : `selectVenue(${idx})`}"><div style="font-weight:bold">${v.name}</div><div class="venue-fee" style="color:${isLocked ? 'red' : 'green'}">${v.desc}</div></div>`;
    });
    document.getElementById('venue-list').innerHTML = html;
}
function selectAnimal(index) { if (isRacing) return; document.querySelectorAll('.bet-card').forEach(c => c.classList.remove('selected')); selectedAnimalIndex = index; document.getElementById(`bet-${index}`).classList.add('selected'); }
function handleAnimalClick(index) { if (isDevMode) devModifyOdds(index); else selectAnimal(index); }
function adjustBet(val) { if(isRacing) return; let input = document.getElementById('bet-amount'); let newVal = (parseInt(input.value) || 0) + val; if (newVal < currentMinBet) newVal = currentMinBet; input.value = newVal; }
function resetBet() { if(!isRacing) document.getElementById('bet-amount').value = currentMinBet; }
// æ–°å¢ ALL IN åŠŸèƒ½
function setAllIn() {
    if (isRacing) return;
    let maxBet = Math.floor(funds / 100) * 100;
    if (maxBet < currentMinBet) maxBet = currentMinBet;
    document.getElementById('bet-amount').value = maxBet;
}

function saveGameData() {
    localStorage.setItem('raceGameFunds', funds);
    localStorage.setItem('raceGameInventory', JSON.stringify(playerInventory));
    localStorage.setItem('raceGameStats', JSON.stringify(playerStats));
    localStorage.setItem('raceGameReliefTime', reliefNextTime); 
    localStorage.setItem('raceGameReliefAccumulated', reliefAccumulated); 
    localStorage.setItem('raceGameDate', new Date().toDateString()); 
}
function loadGameData() {
    funds = parseInt(localStorage.getItem('raceGameFunds')) || 1000;
    playerInventory = JSON.parse(localStorage.getItem('raceGameInventory')) || {};
    let stats = JSON.parse(localStorage.getItem('raceGameStats'));
    if (stats) {
        playerStats = stats;
        // é˜²å‘†è£œé½Šæ–°å±¬æ€§
        if(!playerStats.venueWins) playerStats.venueWins = [0,0,0,0,0];
        if(!playerStats.totalItemsBought) playerStats.totalItemsBought = 0;
        if(!playerStats.maxFundsReached) playerStats.maxFundsReached = 0;
        if(!playerStats.secondPlaceCount) playerStats.secondPlaceCount = 0;
        if(!playerStats.minBetWins) playerStats.minBetWins = 0;
        if(!playerStats.legendaryWins) playerStats.legendaryWins = 0;
        if(!playerStats.turtleRainWins) playerStats.turtleRainWins = 0;
        if(!playerStats.cheetahWindWins) playerStats.cheetahWindWins = 0;
        if(!playerStats.miracleWins) playerStats.miracleWins = 0;
        if(!playerStats.upsetLosses) playerStats.upsetLosses = 0;
    }
    
    let savedRelief = localStorage.getItem('raceGameReliefTime');
    if(savedRelief && savedRelief !== "null") reliefNextTime = parseInt(savedRelief);
    
    let savedAcc = localStorage.getItem('raceGameReliefAccumulated');
    if(savedAcc) reliefAccumulated = parseInt(savedAcc);
}
function checkDailyReset() { let lastDate = localStorage.getItem('raceGameDate'); let today = new Date().toDateString(); if (lastDate !== today) { todayMatchCount = 0; saveGameData(); } }
function saveMatchState() {
    let state = { weatherIdx: WEATHERS.findIndex(w => w.name === currentWeather.name), venueIdx: currentVenueIndex, animalOdds: animals.map(a => a.odds), matchCount: todayMatchCount, isBonus: isBonusRound };
    localStorage.setItem('raceGameMatchState', JSON.stringify(state));
}
function loadMatchState() {
    let saved = localStorage.getItem('raceGameMatchState');
    if (!saved) return false;
    try {
        let state = JSON.parse(saved);
        todayMatchCount = state.matchCount || 0;
        isBonusRound = state.isBonus || false; 
        document.getElementById('bonus-banner').style.display = isBonusRound ? 'block' : 'none';
        selectVenue(state.venueIdx);
        currentWeather = WEATHERS[state.weatherIdx];
        document.getElementById('weather-display').innerText = `${currentWeather.name === 'æ™´å¤©' ? 'â˜€ï¸' : currentWeather.name === 'é›¨å¤©' ? 'ğŸŒ§ï¸' : 'ğŸ’¨'} å¤©æ°£: ${currentWeather.name}`;
        animals = [];
        let venueLen = VENUES[currentVenueIndex].length;
        let bettingHTML = "", trackHTML = "";
        for(let i=0; i<8; i++) {
            let data = ANIMAL_DATA[i];
            let ani = new Animal(i, data, venueLen, currentWeather, state.animalOdds[i]);
            animals.push(ani);
            let favInfo = ani.isFavWeather ? `<div class="fav-weather" style="color:red; font-weight:bold;">ğŸ”¥ å¤©æ°£å„ªå‹¢ï¼</div>` : `<div class="fav-weather">å–œå¥½: ${ani.favWeather}</div>`;
            bettingHTML += `<div class="bet-card" id="bet-${i}" onclick="handleAnimalClick(${i})"><div style="font-size:20px">${ani.icon} ${ani.name}</div>${favInfo}<div class="odds-text" id="odds-display-${i}">x${ani.odds}</div></div>`;
            trackHTML += `<div class="lane" id="lane-${i}" style="top: ${i * 45 + 5}px;"><div class="lane-rank-indicator">#${i+1}</div><div class="lane-name">${ani.icon} ${ani.name}</div><div class="progress-bar" id="bar-${i}"><div class="animal-icon">${ani.icon}</div></div><div class="status-text" id="status-${i}"></div></div>`;
        }
        document.getElementById('betting-area').innerHTML = bettingHTML;
        document.getElementById('track-area').innerHTML = trackHTML;
        selectedAnimalIndex = -1;
        setUIState('idle');
        return true;
    } catch (e) { return false; }
}
function clearMatchState() { localStorage.removeItem('raceGameMatchState'); }

function checkReliefSystem() {
    if (funds >= RELIEF_STOP_THRESHOLD || reliefAccumulated >= RELIEF_MAX_ACCUMULATION) {
        if (reliefNextTime !== null) {
            reliefNextTime = null;
            reliefAccumulated = 0;
            log("ğŸ›‘ æ•‘æ¿Ÿè¨ˆç•«å·²çµæŸ (è³‡é‡‘å……è¶³æˆ–å·²é ˜æ»¿)ã€‚");
            updateFundsDisplay();
        }
        return;
    }
    if (reliefNextTime === null) {
        if (funds < 100) {
            reliefNextTime = Date.now() + RELIEF_INTERVAL;
            reliefAccumulated = 0; 
            log("âš ï¸ è³‡é‡‘çŸ­ç¼ºï¼æ•‘æ¿Ÿè¨ˆç•«å•Ÿå‹• (æ¯10åˆ†é˜ +$100)");
            updateFundsDisplay();
        }
        return;
    }
    let now = Date.now();
    if (now >= reliefNextTime) {
        let timePassed = now - (reliefNextTime - RELIEF_INTERVAL);
        let cycles = Math.floor(timePassed / RELIEF_INTERVAL);
        if (cycles > 0) {
            let basePayout = cycles * 100;
            let remainingQuota = RELIEF_MAX_ACCUMULATION - reliefAccumulated;
            let payout = (basePayout > remainingQuota) ? remainingQuota : basePayout;
            if (payout > 0) {
                funds += payout;
                reliefAccumulated += payout;
                playerStats.totalReliefAmount += payout;
                playerStats.totalRelief += cycles; 
                log(`ğŸš‘ æ”¶åˆ°æ•‘æ¿Ÿé‡‘ $${payout} (ç´¯ç©: $${reliefAccumulated}/$1000)`);
                checkAchievements();
            }
            reliefNextTime += cycles * RELIEF_INTERVAL;
            updateFundsDisplay();
        }
    } else {
        updateReliefUI();
    }
}

function updateFundsDisplay() {
    document.getElementById('funds').innerText = funds;
    updateReliefUI();
    saveGameData(); 
    renderVenues();
}

function updateReliefUI() {
    let panel = document.getElementById('relief-status');
    let timerDisplay = document.getElementById('timer-display');
    let accDisplay = document.getElementById('accumulated-display');
    if (reliefNextTime !== null) {
        panel.style.display = 'block';
        accDisplay.innerText = `$${reliefAccumulated}`;
        let diff = reliefNextTime - Date.now();
        if (diff > 0) {
            let mm = Math.floor(diff / 60000);
            let ss = Math.floor((diff % 60000) / 1000);
            timerDisplay.innerText = `${mm}åˆ†${ss}ç§’ å¾Œ`;
        } else {
            timerDisplay.innerText = "ç™¼æ”¾ä¸­...";
        }
    } else {
        panel.style.display = 'none';
    }
}

function hardResetGame() {
    if (confirm("âš ï¸ è­¦å‘Šï¼šæ‚¨ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰éŠæˆ²é€²åº¦å—ï¼Ÿ\næ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼è³‡é‡‘ã€é“å…·ã€æˆå°±å°‡å…¨éƒ¨æ­¸é›¶ã€‚")) {
        localStorage.removeItem('raceGameFunds');
        localStorage.removeItem('raceGameInventory');
        localStorage.removeItem('raceGameStats');
        localStorage.removeItem('raceGameReliefTime');
        localStorage.removeItem('raceGameReliefAccumulated');
        localStorage.removeItem('raceGameDate');
        localStorage.removeItem('raceGameMatchState');
        location.reload();
    }
}

function log(msg) { let logArea = document.getElementById('game-log'); let p = document.createElement('div'); p.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`; logArea.prepend(p); }
function toggleDevPanel() { if(prompt("å¯†ç¢¼:")==="axin666") { isDevMode=true; document.getElementById('dev-panel').style.display='block'; document.getElementById('dev-trigger-btn').style.display='none'; } }
function exitDevMode() { isDevMode=false; document.getElementById('dev-panel').style.display='none'; document.getElementById('dev-trigger-btn').style.display='block'; }
function devAddFunds() { funds+=1000; updateFundsDisplay(); }
function devResetMatch() { if(!isRacing) { clearMatchState(); resetMatch(true); } }
function devModifyOdds(index) { let ani = animals[index]; let newOdds = prompt(`ä¿®æ”¹ ${ani.name} è³ ç‡:`, ani.odds); if(newOdds && !isNaN(newOdds)) { ani.odds = parseFloat(newOdds).toFixed(2); ani.recalcSpeed(VENUES[currentVenueIndex].length, currentWeather); document.getElementById(`odds-display-${index}`).innerText=`x${ani.odds}`; saveMatchState(); } }
</script>

</body>
</html>

